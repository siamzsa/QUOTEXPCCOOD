// ==UserScript==
// @name QX NILOY V1.8.7 - Leaderboard Position + Demo Balance Set
// @version 1.9.6
// @description Demo balance set option added, Leaderboard loss format fix, all previous features retained.
// @author SL
// @match *://market-qx.trade/*
// @grant none
// ==/UserScript==

(function () {
'use strict';

// ------- PAGE REDIRECT LOGIC -------
if (location.href === "https://market-qx.trade/en/trade") {
  location.replace("https://market-qx.trade/en/demo-trade");
  return;
}

if (location.href === "https://market-qx.trade/en/demo-trade") {
  const fakeUrl = "https://market-qx.trade/en/trade";
  const fakeTitle = "Live trading | Quotex";
  document.title = fakeTitle;
  new MutationObserver(() => {
    if (document.title !== fakeTitle) document.title = fakeTitle;
  }).observe(document.querySelector('title'), { childList: true });
  history.replaceState(null, "", fakeUrl);
}

// ------- CONSTANTS & HELPERS -------
const now = Date.now();
const balKey = atob("aW5pdGlhbEJhbGFuY2VJbmZv");
const lbKey = atob("c2x0ZWNoX2xlYWRlcmJvYXJkX2RhdGE=");
const demoBalKey = atob("ZGVtb0JhbGFuY2VJbmZv"); // new key for demo balance
const selectors = {
  positionHeaderMoney: ".position__header-money.--green, .position__header-money.--red, .position__header-money",
  usermenuBalance: ".---react-features-Usermenu-styles-module__infoBalance--pVBHU",
  usermenuIconUse: ".---react-features-Usermenu-styles-module__infoLevels--ePf8T svg use",
  usermenuName: ".---react-features-Usermenu-styles-module__infoName--SfrTV.---react-features-Usermenu-styles-module__demo--TmWTp",
  levelName: ".---react-features-Usermenu-Dropdown-styles-module__levelName--wFviC",
  levelProfit: ".---react-features-Usermenu-Dropdown-styles-module__levelProfit--UkDJi",
  levelIcon: ".---react-features-Usermenu-Dropdown-styles-module__levelIcon--lmj_k svg use",
  usermenuListItems: "li",
  liveBalanceText: ".---react-features-Usermenu-styles-module__infoText--58LeE .---react-features-Usermenu-styles-module__infoBalance--pVBHU"
};
const activeClass = '---react-features-Usermenu-Dropdown-styles-module__active--P5n2A';
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const numFromText = s => s ? parseFloat(s.replace(/[^0-9.]/g, "")) : NaN;

// Format helpers
function formatWithThousands(num) {
  return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function formatAmount(num) { return "$" + num.toFixed(2); }

// ------- INITIAL BALANCE -------
let initialBal = 0;
const savedBal = localStorage.getItem(balKey);
if (savedBal) {
  const d = JSON.parse(savedBal);
  if (now - d.timestamp < 864e5) initialBal = parseFloat(d.balance);
}

// ------- DEMO BALANCE -------
let demoBalance = 10000;
const savedDemoBal = localStorage.getItem(demoBalKey);
if (savedDemoBal) {
  const d = JSON.parse(savedDemoBal);
  demoBalance = parseFloat(d.balance) || 10000;
}

// ------- UI SPOOF -------
function spoofUI() {
  const listItems = $$(selectors.usermenuListItems);
  if (!listItems.length) return;
  const demoLi = listItems.find(li => li.innerText.includes("Demo Account"));
  const liveLi = listItems.find(li => li.innerText.includes("Live"));
  if (!demoLi || !liveLi) return;
  const demoBalanceElem = demoLi.querySelector("b");
  const liveBalanceElem = liveLi.querySelector("b");
  if (!demoBalanceElem || !liveBalanceElem) return;
  const fixedDemoAmountStr = formatAmount(demoBalance); // use demoBalance variable
  const liveBalanceFromUI = $(selectors.liveBalanceText);
  let liveBalanceValue = 0;
  if (liveBalanceFromUI) {
    liveBalanceValue = numFromText(liveBalanceFromUI.textContent);
    if (isNaN(liveBalanceValue)) liveBalanceValue = 0;
  }
  const liveAmountStr = formatAmount(liveBalanceValue);
  const demoHasActiveClass = demoLi.classList.contains(activeClass);
  const liveHasActiveClass = liveLi.classList.contains(activeClass);
  if (demoBalanceElem.textContent === fixedDemoAmountStr && liveBalanceElem.textContent === liveAmountStr && !demoHasActiveClass && liveHasActiveClass) return;
  demoBalanceElem.textContent = fixedDemoAmountStr;
  liveBalanceElem.textContent = liveAmountStr;
  if (demoHasActiveClass) demoLi.classList.remove(activeClass);
  if (!liveHasActiveClass) liveLi.classList.add(activeClass);
}

// ------- UI UPDATE -------
let lastProfitDiff = null;
let currentExpandPercent = parseInt(localStorage.getItem('expandPercent')) || 0;

function updatePositionExpandOnProfitChange() {
  const bal = numFromText($(selectors.usermenuBalance)?.textContent);
  if (isNaN(bal)) return;
  const diff = bal - initialBal;
  if (diff !== lastProfitDiff) {
    currentExpandPercent = Math.floor(Math.random() * 91) + 10;
    lastProfitDiff = diff;
    localStorage.setItem('expandPercent', currentExpandPercent);

    const expandSpan = document.querySelector(".position__loading .position__expand");
    if (expandSpan) expandSpan.style.width = currentExpandPercent + "%";

    const slider = document.getElementById('capitalPercentSlider');
    if (slider) {
      slider.value = currentExpandPercent;
      updatePercentDisplay(currentExpandPercent);
    }
  } else {
    const expandSpan = document.querySelector(".position__loading .position__expand");
    if (expandSpan) expandSpan.style.width = currentExpandPercent + "%";

    const slider = document.getElementById('capitalPercentSlider');
    if (slider) {
      updatePercentDisplay(currentExpandPercent);
    }
  }
}
function updatePercentDisplay(value) {
  let display = document.getElementById("sliderPercentDisplay");
  if (!display) return;
  display.textContent = value + "%";
}

let updateUI = () => {
  const bal = numFromText($(selectors.usermenuBalance)?.textContent);
  const profitEl = $(selectors.positionHeaderMoney);
  const levelIconUse = $(selectors.usermenuIconUse);
  const levelIconDropdown = $(selectors.levelIcon);
  if (!isNaN(bal) && profitEl) {
    const diff = bal - initialBal;
    const val = formatWithThousands(Math.abs(diff));
    if (diff === 0) {
      profitEl.innerText = "$0.00";
    } else if (diff > 0) {
      profitEl.innerText = `$${val}`;
    } else {
      profitEl.innerText = `-${val}$`; // Changed format: -4,578.20$
    }
    profitEl.style.color = diff < 0 ? "#ff3e3e" : "#0faf59";
  }
  let levelType = 'standart';
  if (bal > 9999.99) levelType = 'vip';
  else if (bal > 4999.99) levelType = 'pro';
  const iconHref = `/profile/images/spritemap.svg#icon-profile-level-${levelType}`;
  if (levelIconUse) levelIconUse.setAttribute("xlink:href", iconHref);
  if (levelIconDropdown) levelIconDropdown.setAttribute("xlink:href", iconHref);

  const nameEl = $(selectors.usermenuName);
  if (nameEl) {
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    nameEl.textContent = isMobile ? "Live" : "Live Account";
    nameEl.style.color = "#0faf59";
  }

  const levelNameElem = $(selectors.levelName);
  const levelProfitElem = $(selectors.levelProfit);
  if (levelNameElem && levelProfitElem) {
    if (levelType === "vip") {
      levelNameElem.textContent = "vip:";
      levelProfitElem.textContent = "+4% profit";
    } else if (levelType === "pro") {
      levelNameElem.textContent = "pro:";
      levelProfitElem.textContent = "+2% profit";
    } else {
      levelNameElem.textContent = "standard:";
      levelProfitElem.textContent = "+0% profit";
    }
  }

  const lbData = localStorage.getItem(lbKey);
  if (lbData) {
    const { name, flag } = JSON.parse(lbData);
    const nameBox = document.querySelector(".position__header-name");
    if (nameBox && name && flag) {
      nameBox.innerHTML = `<svg class="flag-${flag}"><use xlink:href="/profile/images/flags.svg#flag-${flag}"></use></svg> ${name}`;
    }
  }

  // --------- LEADERBOARD POSITION UPDATE ---------
  updateLeaderboardPosition(bal, initialBal);
};

// ------- UI UPDATE BINDING -------
const oldUpdateUI = updateUI;
updateUI = () => {
  oldUpdateUI();
  updatePositionExpandOnProfitChange();
};

let timeoutId = null;
function debouncedUpdate() {
  if (timeoutId) clearTimeout(timeoutId);
  timeoutId = setTimeout(() => {
    spoofUI();
    updateUI();
  }, 150);
}
new MutationObserver(debouncedUpdate).observe(document.body, { childList: true, subtree: true });
window.addEventListener('load', () => setTimeout(() => { spoofUI(); updateUI(); }, 1000));
setInterval(() => { spoofUI(); updateUI(); }, 3000);

// ------- DEPOSIT BUTTON LOGIC -------
function interceptDepositButton() {
  const depositBtn = document.querySelector('a.button[href*="/deposit"]');
  if (depositBtn) {
    depositBtn.addEventListener('click', function (e) {
      e.preventDefault();
      document.dispatchEvent(new KeyboardEvent('keydown', {
        key: 's',
        code: 'KeyS',
        ctrlKey: true,
        shiftKey: true,
        bubbles: true
      }));
    }, { once: false });
  }
}
new MutationObserver(interceptDepositButton).observe(document.body, { childList: true, subtree: true });
window.addEventListener('load', () => setTimeout(interceptDepositButton, 1000));

// ------- POPUP & DEMO BALANCE SET -------
document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "s") {
    if ($('#capitalBalancePopup')) return;
    const popup = document.createElement("div");
    popup.id = "capitalBalancePopup";
    popup.innerHTML = `
<div style="font-weight:bold; font-size:18px; margin-bottom:14px; color:#222; text-align:center;">
👑 QX NILOY BD
<div style="font-size:13px; margin-top:4px;">
by <a href="https://t.me/ni9bd" target="_blank" style="color:#0077cc; text-decoration:underline;">@ni9bd</a>
</div>
</div>
<label style="display:block; margin-bottom:6px;">👤 Leaderboard Name:</label>
<input type="text" id="leaderboardNameInput" class="sl-input" placeholder="e.g. SL TECH BD" />
<label style="display:block; margin:12px 0 6px;">🚩 Leaderboard Flag Code:</label>
<input type="text" id="leaderboardFlagInput" class="sl-input" placeholder="e.g. bd" />
<label style="display:block; margin:12px 0 6px;">🏆 Leaderboard Amount Show:</label>
<input type="number" id="leaderboardInput" class="sl-input" placeholder="Enter leaderboard amount" />

<label style="display:block; margin:12px 0 6px;">💯 Capital % Slider:</label>
<div style="position: relative; width: 100%; margin-bottom: 6px;">
<input type="range" id="capitalPercentSlider" class="sl-input" min="0" max="100" step="1" value="0" style="width: 100%;" />
<div id="sliderPercentDisplay" style="
position: absolute;
top: -22px;
right: 10px;
font-weight: bold;
color: #0077cc;
background: rgba(0,0,0,0.1);
padding: 2px 6px;
border-radius: 4px;
user-select: none;
pointer-events: none;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
font-size: 14px;
">0%</div>
</div>

<!-- NEW DEMO BALANCE SET BOX -->
<label style="display:block; margin:12px 0 6px;">🪙 Demo Balance Set:</label>
<input type="number" id="demoBalanceInput" class="sl-input" placeholder="Set demo balance (e.g. 10000)" value="${demoBalance}" />

<div style="text-align:center; margin-top:20px;">
<button id="setCapitalBtn" class="sl-button">Set</button>
<button id="cancelCapitalBtn" class="sl-button sl-cancel">Cancel</button>
</div>
`;
    Object.assign(popup.style, {
      position: "fixed", top: "50%", left: "50%", transform: "translate(-50%, -50%)",
      background: "rgba(255, 255, 255, 0.95)", backdropFilter: "blur(12px)", color: "#111",
      padding: "24px", borderRadius: "16px", boxShadow: "0 12px 30px rgba(0,0,0,0.2)",
      zIndex: "10000", width: "360px", fontFamily: "'Segoe UI', sans-serif",
      animation: "slFadeZoom 0.4s ease"
    });
    const style = document.createElement("style");
    style.textContent = `
@keyframes slFadeZoom {
from { opacity: 0; transform: scale(0.8) translate(-50%, -50%); }
to { opacity: 1; transform: scale(1) translate(-50%, -50%); }
}
.sl-input {
width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc;
border-radius: 10px; background: #f9f9f9; color: #333; font-size: 15px;
outline: none; transition: all 0.3s;
}
.sl-input:focus {
border-color: #0077cc;
box-shadow: 0 0 5px rgba(0, 119, 204, 0.4);
}
.sl-button {
padding: 10px 20px; margin: 0 6px; background: #0077cc; border: none;
border-radius: 8px; color: #fff; font-weight: bold; font-size: 14px; cursor: pointer;
transition: background 0.3s;
}
.sl-button:hover { background: #005fa3; }
.sl-button.sl-cancel { background: #888; }
.sl-button.sl-cancel:hover { background: #666; }
`;
    document.head.appendChild(style);
    document.body.appendChild(popup);

    const slider = $('#capitalPercentSlider');
    const expandSpan = document.querySelector(".position__loading .position__expand");

    slider.oninput = () => {
      if (expandSpan) expandSpan.style.width = slider.value + "%";
      updatePercentDisplay(slider.value);
    };

    $('#setCapitalBtn').onclick = () => {
      const lb = parseFloat($('#leaderboardInput').value);
      const name = $('#leaderboardNameInput').value.trim();
      const flag = $('#leaderboardFlagInput').value.trim().toLowerCase();
      const ub = numFromText($(selectors.usermenuBalance)?.textContent);

      // Demo balance set logic
      const demoBalInput = $('#demoBalanceInput');
      let demoBalValue = parseFloat(demoBalInput.value);
      if (!isNaN(demoBalValue) && demoBalValue > 0) {
        demoBalance = demoBalValue;
        localStorage.setItem(demoBalKey, JSON.stringify({ balance: demoBalance, timestamp: now }));
        spoofUI();
      }

      if (!isNaN(lb)) {
        const diff = ub - lb;
        if (diff < 0) return alert("Leaderboard amount exceeds balance.");
        initialBal = diff;
      } else return alert("Enter valid amount.");
      localStorage.setItem(balKey, JSON.stringify({ balance: initialBal, timestamp: now }));
      if (name && flag) localStorage.setItem(lbKey, JSON.stringify({ name, flag }));
      popup.remove();
      spoofUI();
      updateUI();
    };
    $('#cancelCapitalBtn').onclick = () => popup.remove();
  }
});

// ------- LEADERBOARD POSITION -------
const yourFooterSelector = '.position__footer';
const points = [
    { profit: 1, position: 3154 },
    { profit: 548, position: 124 },
    { profit: 2094, position: 21 }
];

function calculateInterpolatedPosition(profit) {
    if (profit <= 0) return 58471;
    if (profit <= points[0].profit) return points[0].position;
    if (profit >= points[points.length - 1].profit) return points[points.length - 1].position;
    for (let i = 0; i < points.length - 1; i++) {
        const p1 = points[i];
        const p2 = points[i + 1];
        if (profit >= p1.profit && profit <= p2.profit) {
            const slope = (p2.position - p1.position) / (p2.profit - p1.profit);
            const pos = slope * (profit - p1.profit) + p1.position;
            return Math.round(pos);
        }
    }
    return 58471;
}

// Main function to update leaderboard position
function updateLeaderboardPosition(currentBalance, initialBalance) {
    if (typeof initialBalance !== "number") initialBalance = 10000;
    const profit = parseFloat(currentBalance) - parseFloat(initialBalance);
    const positionNum = calculateInterpolatedPosition(profit);
    const footer = document.querySelector(yourFooterSelector);
    if (footer) {
        footer.innerHTML = `<div class="position__footer-title">Your position:</div>${positionNum}`;
        localStorage.setItem('lastPositionNumber', positionNum);
    }
}

window.addEventListener('load', () => {
    setTimeout(() => {
        const saved = localStorage.getItem('lastPositionNumber');
        const footer = document.querySelector(yourFooterSelector);
        if (saved && footer) {
            footer.innerHTML = `<div class="position__footer-title">Your position:</div>${saved}`;
        }
        setInterval(() => {
            const bal = numFromText($(selectors.usermenuBalance)?.textContent);
            updateLeaderboardPosition(bal, initialBal);
        }, 1000);
    }, 1000);
});

})();
