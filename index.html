// =============================
// License Verification Popup
// =============================

(function loadFirebase(cb){
  if (typeof firebase === "undefined") {
    const s1 = document.createElement("script");
    s1.src = "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";
    s1.onload = function(){
      const s2 = document.createElement("script");
      s2.src = "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js";
      s2.onload = cb;
      document.head.appendChild(s2);
    };
    document.head.appendChild(s1);
  } else {
    cb();
  }
})(main);

// =============================
// Main Script
// =============================
function main() {
  function getDeviceId() {
    let deviceId = localStorage.getItem("verifier_device_id");
    if (!deviceId) {
      deviceId = "dev_" + Math.random().toString(36).substr(2,16) + "_" + Math.floor(Date.now()/1000);
      localStorage.setItem("verifier_device_id", deviceId);
    }
    return deviceId;
  }

  const firebaseConfig = {
    apiKey: "AIzaSy8m3iuH0de6K31q58DlDcm4RFsJfNTt0Y",
    authDomain: "xsiam-8cd91.firebaseapp.com",
    databaseURL: "https://xsiam-8cd91-default-rtdb.firebaseio.com",
    projectId: "xsiam-8cd91",
    storageBucket: "xsiam-8cd91.appspot.com",
    messagingSenderId: "449795686178",
    appId: "1:449795686178:web:67631b23b88be6a0eaef7b",
    measurementId: "G-C987LSZV4G"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Remove old popup if exists
  const old = document.getElementById("licenseOverlay");
  if (old) old.remove();

  // Overlay + Box create
  const overlay = document.createElement("div");
  overlay.id = "licenseOverlay";
  overlay.style.cssText = `
    position:fixed;top:0;left:0;width:100%;height:100%;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,0.4);z-index:99999;
  `;
  const box = document.createElement("div");
  box.id = "licenseBox";
  box.style.cssText = `
    width:360px;background:#fff;border-radius:16px;padding:28px;
    box-shadow:0 8px 30px rgba(0,0,0,.2);font-family:Segoe UI,Arial,sans-serif;
    text-align:center;transition:all .6s ease;
  `;

  // Placeholder for IP address
  let userIP = "Loading...";

  box.innerHTML = `
    <h2 style="color:#0d6efd;margin:0 0 18px">License Verification</h2>
    <input id="licenseKey" type="text" placeholder="Enter license key"
      style="width:100%;padding:12px;border:2px solid #cfd8fc;border-radius:8px;font-size:16px;margin-bottom:12px;"/>
    <button id="verifyBtn" style="width:100%;padding:12px;border:none;border-radius:8px;
      background:#0d6efd;color:#fff;font-size:16px;font-weight:600;cursor:pointer;">Verify License</button>
    <div id="statusBox" style="margin-top:15px;font-size:15px;min-height:22px"></div>
    <div id="deviceInfo" style="font-size:12px;color:#666;margin-top:8px;">
      Device ID: ${getDeviceId()} <br/> IP Address: ${userIP}
    </div>
  `;
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  // Fetch public IP
  async function fetchPublicIP() {
    try {
      const res = await fetch("https://api64.ipify.org?format=json");
      const data = await res.json();
      userIP = data.ip;
    } catch (err) {
      console.error("Could not fetch IP:", err);
      userIP = "Unknown";
    }
    document.getElementById("deviceInfo").innerHTML = `Device ID: ${getDeviceId()} <br/> IP Address: ${userIP}`;
  }

  fetchPublicIP();

  // Hide popup
  function hidePopup() {
    box.style.opacity = "0";
    box.style.transform = "scale(0.9)";
    setTimeout(()=> overlay.remove(), 700);
  }

  // Main verification
  async function verifyLicense(licenseKey, deviceId) {
    const statusBox = document.getElementById("statusBox");
    statusBox.innerHTML = "‚è≥ Verifying...";
    try {
      const snap = await db.collection("licenses").where("key", "==", licenseKey).get();
      if (snap.empty) {
        statusBox.innerHTML = "‚ùå License not found!";
        return;
      }
      const doc = snap.docs[0];
      const data = doc.data();

      await db.collection("licenses").doc(doc.id).collection("devices").doc(deviceId)
        .set({ 
          registeredAt: firebase.firestore.FieldValue.serverTimestamp(), 
          browser: navigator.userAgent, 
          ip: userIP 
        }, {merge:true});

      let activeDevices = 0;
      try {
        const deviceSnap = await db.collection("licenses").doc(doc.id).collection("devices").get();
        activeDevices = deviceSnap.size;
      } catch {}

      if (activeDevices > (data.maxDevices || 1)) {
        statusBox.innerHTML = `üö® BLOCKED! Devices: ${activeDevices}/${data.maxDevices||1}`;
      } else if (!data.active) {
        statusBox.innerHTML = "‚õî License INACTIVE";
      } else {
        statusBox.innerHTML = `‚úÖ VALID! Devices: ${activeDevices}/${data.maxDevices||1}`;
        setTimeout(hidePopup, 2000);
      }
    } catch (err) {
      statusBox.innerHTML = "‚ùå Error: " + err.message;
    }
  }

  // Button click
  document.getElementById("verifyBtn").onclick = function() {
    const licenseKey = document.getElementById("licenseKey").value.trim();
    if (!licenseKey) {
      document.getElementById("statusBox").innerHTML = "‚ö†Ô∏è Please enter a license key.";
      return;
    }
    verifyLicense(licenseKey, getDeviceId());
  };

  // Console helper
  window.verifyLicenseConsole = async function(licenseKey) {
    console.log("üîë License Key:", licenseKey);
    const deviceId = getDeviceId();
    try {
      const snap = await db.collection("licenses").where("key", "==", licenseKey).get();
      if (snap.empty) { console.error("‚ùå License not found!"); return; }
      const doc = snap.docs[0];
      const data = doc.data();

      await db.collection("licenses").doc(doc.id).collection("devices").doc(deviceId)
        .set({ 
          registeredAt: firebase.firestore.FieldValue.serverTimestamp(), 
          browser: navigator.userAgent, 
          ip: userIP 
        }, {merge:true});

      let activeDevices = 0;
      try {
        const deviceSnap = await db.collection("licenses").doc(doc.id).collection("devices").get();
        activeDevices = deviceSnap.size;
      } catch {}

      if (activeDevices > (data.maxDevices||1)) {
        console.warn("üö® BLOCKED! Devices:", activeDevices+"/"+(data.maxDevices||1));
      } else if (!data.active) {
        console.warn("‚õî INACTIVE LICENSE");
      } else {
        console.log("‚úÖ VALID LICENSE. Devices:", activeDevices+"/"+(data.maxDevices||1));
        setTimeout(hidePopup, 2000);
      }
    } catch (e) {
      console.error("‚ùå Error:", e.message);
    }
  };

  console.log("üëâ Console use: verifyLicenseConsole('YOUR-LICENSE-KEY');");
}
