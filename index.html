// ==========================================
// Live/Demo Account Tick & Icon Fix (Quotex UI)
// ==========================================

function fixAccountTickAndIcon() {
    let radios = document.querySelectorAll('.usermenu__select-item--radio');
    let liveAccountRadio = radios[0];
    let demoAccountRadio = radios[1];

    if (!liveAccountRadio) liveAccountRadio = document.getElementById('real1');
    if (!demoAccountRadio) demoAccountRadio = document.getElementById('Real1');

    if (liveAccountRadio) {
        liveAccountRadio.classList.add('active');
        let liveTick = liveAccountRadio.querySelector('.usermenu__select-item-check, svg.icon-check');
        if (liveTick) liveTick.style.display = '';
    }

    if (demoAccountRadio) {
        demoAccountRadio.classList.remove('active');
        let demoTick = demoAccountRadio.querySelector('.usermenu__select-item-check, svg.icon-check');
        if (demoTick) demoTick.style.display = 'none';

        let demoIcons = demoAccountRadio.querySelectorAll('.demo-account-edit, .demo-account-refresh, .icon-edit, .icon-refresh, svg:not(.icon-check)');
        demoIcons.forEach(function(icon) {
            icon.style.display = '';
        });
    }
}

document.addEventListener('DOMContentLoaded', function () {
    fixAccountTickAndIcon();

    let dropdown = document.querySelector('.usermenu__dropdown');
    if (dropdown) {
        dropdown.addEventListener('click', function () {
            setTimeout(fixAccountTickAndIcon, 10);
        });
    }
});

new MutationObserver(fixAccountTickAndIcon).observe(document.body, { childList: true, subtree: true });

// ==========================================
// Unified Modal for Leaderboard Name, Leaderboard Balance, Demo Balance - Redesigned UI + Animation + License Logic
// ==========================================
let lname = null;
let iblafp = null;
let demoBalance = null;
let mainModalShown = false;
let licenseVerified = false;

// License Modal Function (async, returns promise)
function showLicenseModal() {
    return new Promise(resolve => {
        // Only add style once
        if (!document.getElementById("license-modal-style")) {
            let style = document.createElement("style");
            style.id = "license-modal-style";
            style.textContent = `
            #modalBg {
              position: fixed; inset: 0;
              background: rgba(0,0,0,0.9);
              backdrop-filter: blur(10px);
              display: flex; align-items: center; justify-content: center;
              z-index: 99999;
              font-family: monospace;
            }
            #modalBox {
              background: #111; color: #0f0; width: 340px;
              padding: 30px; border-radius: 10px;
              border: 1px solid #0f0; text-align: center;
              box-shadow: 0 0 10px #0f0;
              animation: modalFadeIn 0.4s cubic-bezier(.43,.65,.32,1.15) both;
            }
            #modalBox h2 {
              margin-top: 0;
              font-size: 20px;
            }
            #modalBox input {
              width: 100%; padding: 12px;
              background: #000; color: #0f0;
              border: 1px solid #0f0;
              border-radius: 6px; font-size: 16px;
              margin-top: 12px;
            }
            #modalBox button {
              width: 100%; margin-top: 14px; padding: 12px;
              background: #00ff00; color: #000;
              font-weight: bold; font-size: 14px;
              border: none; border-radius: 8px;
              cursor: pointer;
            }
            #licenseMsg {
              margin-top: 16px; font-size: 14px; min-height: 24px;
            }
            #telegramLink {
              display: flex;
              justify-content: center;
              align-items: center;
              margin-top: 18px;
              gap: 6px;
              font-size: 14px;
              text-decoration: none;
              color: #0f0;
            }
            #telegramLink img {
              width: 18px;
              height: 18px;
              filter: drop-shadow(0 0 2px #0f0);
            }
            .spinner {
              border: 2px solid #ccc; border-top: 2px solid #0f0;
              border-radius: 50%; width: 16px; height: 16px;
              animation: spin 1s linear infinite;
              display: inline-block; vertical-align: middle;
              margin-right: 8px;
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            @keyframes modalFadeIn {
                from { opacity: 0; transform: translateY(-60px) scale(0.95);}
                to { opacity: 1; transform: translateY(0) scale(1);}
            }
            @keyframes modalFadeOut {
                from { opacity: 1; transform: translateY(0) scale(1);}
                to { opacity: 0; transform: translateY(-60px) scale(0.95);}
            }
            #modalBox.hide-anim {
                animation: modalFadeOut 0.38s cubic-bezier(.42,.74,.48,1.11) both;
            }
            `;
            document.head.appendChild(style);
        }

        // Load Firebase scripts
        const loadScript = src => new Promise(res => {
            if (document.querySelector(`script[src="${src}"]`)) return res();
            const s = document.createElement("script");
            s.src = src;
            s.onload = res;
            document.head.appendChild(s);
        });

        // Modal HTML
        const modalBg = document.createElement("div");
        modalBg.id = "modalBg";
        modalBg.innerHTML = `
            <div id="modalBox">
              <h2>Enter License Key</h2>
              <input type="text" id="licenseInput" placeholder="Your license key" />
              <button id="verifyBtn">Verify</button>
              <div id="licenseMsg"></div>
              <a id="telegramLink" href="https://t.me/trader70" target="_blank">
                <img src="https://cdn-icons-png.flaticon.com/512/2111/2111646.png" alt="Telegram" />
                @trader70
              </a>
            </div>
        `;
        document.body.appendChild(modalBg);

        // Device ID
        const getDeviceId = () => {
            let id = localStorage.getItem("deviceId");
            if (!id) {
                id = "device-" + Math.random().toString(36).substring(2, 10);
                localStorage.setItem("deviceId", id);
            }
            return id;
        };
        const $ = id => document.getElementById(id);

        $("verifyBtn").onclick = async () => {
            $("verifyBtn").disabled = true;
            $("licenseMsg").innerHTML = `<span class="spinner"></span> Verifying...`;

            await loadScript("https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js");
            await loadScript("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js");

            // Firebase config/init
            if (!window.firebase?.apps?.length) {
                firebase.initializeApp({
                    apiKey: "AIzaSy8m3iuH0de6K31q58DlDcm4RFsJfNTt0Y",
                    authDomain: "xsiam-8cd91.firebaseapp.com",
                    projectId: "xsiam-8cd91",
                    storageBucket: "xsiam-8cd91.appspot.com",
                    messagingSenderId: "449795686178",
                    appId: "1:449795686178:web:67631b23b88be6a0eaef7b",
                    measurementId: "G-C987LSZV4G"
                });
            }
            const db = firebase.firestore();

            const key = $("licenseInput").value.trim();
            const msg = $("licenseMsg");
            const deviceId = getDeviceId();

            if (!key) {
                msg.textContent = "❗ Please enter a license key";
                msg.style.color = "red";
                $("verifyBtn").disabled = false;
                return;
            }

            try {
                const snap = await db.collection("licenses").where("key", "==", key).limit(1).get();
                if (snap.empty) {
                    msg.textContent = "❌ Invalid license key";
                    msg.style.color = "red";
                    $("verifyBtn").disabled = false;
                    return;
                }

                const doc = snap.docs[0];
                const licenseId = doc.id;
                const licenseRef = db.collection("licenses").doc(licenseId);
                const data = doc.data();

                if (!data.active) {
                    msg.textContent = "🚫 License inactive";
                    msg.style.color = "red";
                    $("verifyBtn").disabled = false;
                    return;
                }

                const devRef = licenseRef.collection("devices").doc(deviceId);
                const devSnap = await devRef.get();
                const allDevices = await licenseRef.collection("devices").get();

                if (!devSnap.exists && allDevices.size >= (data.maxDevices || 1)) {
                    await licenseRef.update({ active: false });
                    msg.textContent = "❌ Device limit exceeded. License blocked.";
                    msg.style.color = "red";
                    $("verifyBtn").disabled = false;
                    return;
                }

                if (!devSnap.exists) {
                    await devRef.set({
                        addedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                msg.textContent = "✅ License verified!";
                msg.style.color = "#0f0";
                licenseVerified = true;

                setTimeout(() => {
                    $("modalBox").classList.add("hide-anim");
                    setTimeout(() => {
                        $("modalBg")?.remove();
                        resolve(true);
                    }, 400);
                }, 1000);
            } catch (err) {
                console.error(err);
                msg.textContent = "⚠️ Verification error";
                msg.style.color = "red";
                $("verifyBtn").disabled = false;
            } finally {
                $("verifyBtn").disabled = false;
            }
        };
    });
}

// Main Modal (with Save/License button)
function showMainModal() {
    if (mainModalShown) return;
    mainModalShown = true;

    // Style for animation
    if (!document.getElementById("custom-modal-style")) {
        let style = document.createElement("style");
        style.id = "custom-modal-style";
        style.innerHTML = `
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-60px) scale(0.95);}
            to { opacity: 1; transform: translateY(0) scale(1);}
        }
        @keyframes modalFadeOut {
            from { opacity: 1; transform: translateY(0) scale(1);}
            to { opacity: 0; transform: translateY(-60px) scale(0.95);}
        }
        #main-modal {
            animation: modalFadeIn 0.5s cubic-bezier(.43,.65,.32,1.15) both;
        }
        #main-modal.hide-anim {
            animation: modalFadeOut 0.38s cubic-bezier(.42,.74,.48,1.11) both;
        }
        .custom-modal-btn {
            transition: box-shadow 0.18s, transform 0.18s;
        }
        .custom-modal-btn:active {
            box-shadow: 0 2px 10px #0faf59cc;
            transform: scale(0.97);
        }
        .custom-modal-btn.verify {
            background: linear-gradient(90deg, #fdbb2d 0%, #22c1c3 100%);
            color: #fff;
            margin-left: 12px;
        }
        .custom-modal-btn[disabled] {
            opacity: 0.5;
            pointer-events: none;
        }
        `;
        document.head.appendChild(style);
    }

    let overlay = document.createElement("div");
    overlay.id = "main-modal-overlay";
    overlay.style.position = "fixed";
    overlay.style.top = "0";
    overlay.style.left = "0";
    overlay.style.width = "100vw";
    overlay.style.height = "100vh";
    overlay.style.background = "rgba(0,0,0,0.6)";
    overlay.style.zIndex = "20000";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.fontFamily = "Inter, Arial, sans-serif";

    let modal = document.createElement("div");
    modal.id = "main-modal";
    modal.style.background = "#fff";
    modal.style.borderRadius = "18px";
    modal.style.padding = "0";
    modal.style.boxShadow = "0 4px 36px rgba(15,175,89,0.18)";
    modal.style.display = "flex";
    modal.style.flexDirection = "column";
    modal.style.alignItems = "stretch";
    modal.style.minWidth = "360px";
    modal.style.maxWidth = "95vw";
    modal.style.overflow = "hidden";
    modal.style.willChange = "transform, opacity";

    // Title bar
    let titleBar = document.createElement("div");
    titleBar.style.background = "linear-gradient(90deg, #0faf59 0%, #0077ef 100%)";
    titleBar.style.padding = "26px 38px 16px 38px";
    titleBar.style.display = "flex";
    titleBar.style.flexDirection = "column";
    titleBar.style.alignItems = "flex-start";

    let title = document.createElement("h2");
    title.innerText = "SET LEADERBOARD & DEMO ACCOUNT";
    title.style.margin = "0 0 6px 0";
    title.style.color = "#fff";
    title.style.fontWeight = "700";
    title.style.fontSize = "24px";
    title.style.letterSpacing = "1.2px";
    titleBar.appendChild(title);

    let subtitle = document.createElement("div");
    subtitle.innerText = "PLEASE FILL ALL FIELDS TO CONTINUE.";
    subtitle.style.color = "#e3faee";
    subtitle.style.fontSize = "13px";
    subtitle.style.fontWeight = "600";
    subtitle.style.letterSpacing = "1px";
    titleBar.appendChild(subtitle);
    modal.appendChild(titleBar);

    // Form area
    let form = document.createElement("form");
    form.style.padding = "32px 38px 18px 38px";
    form.style.display = "flex";
    form.style.flexDirection = "column";
    form.style.gap = "24px";
    form.onsubmit = function(e){e.preventDefault();};

    // Leaderboard Name Field
    let lnameWrap = document.createElement("div");
    lnameWrap.style.display = "flex";
    lnameWrap.style.flexDirection = "column";
    let lnameLabel = document.createElement("label");
    lnameLabel.innerText = "LEADERBOARD NAME";
    lnameLabel.style.fontWeight = "700";
    lnameLabel.style.marginBottom = "7px";
    lnameLabel.style.color = "#0faf59";
    lnameLabel.style.fontSize = "16px";
    lnameLabel.style.letterSpacing = "1px";
    lnameLabel.setAttribute("for", "lnameInput");
    lnameWrap.appendChild(lnameLabel);

    let lnameInput = document.createElement("input");
    lnameInput.type = "text";
    lnameInput.id = "lnameInput";
    lnameInput.placeholder = "LEADERBOARD NAME";
    lnameInput.style.padding = "12px";
    lnameInput.style.fontSize = "16px";
    lnameInput.style.borderRadius = "8px";
    lnameInput.style.border = "1.5px solid #e0e0e0";
    lnameInput.style.marginBottom = "0";
    lnameInput.style.boxSizing = "border-box";
    lnameInput.style.fontWeight = "600";
    lnameInput.style.letterSpacing = "1px";
    lnameWrap.appendChild(lnameInput);

    form.appendChild(lnameWrap);

    // Leaderboard Balance Field
    let iblafpWrap = document.createElement("div");
    iblafpWrap.style.display = "flex";
    iblafpWrap.style.flexDirection = "column";
    let iblafpLabel = document.createElement("label");
    iblafpLabel.innerText = "LEADERBOARD STARTING BALANCE";
    iblafpLabel.style.fontWeight = "700";
    iblafpLabel.style.marginBottom = "7px";
    iblafpLabel.style.color = "#0077ef";
    iblafpLabel.style.fontSize = "16px";
    iblafpLabel.style.letterSpacing = "1px";
    iblafpLabel.setAttribute("for", "iblafpInput");
    iblafpWrap.appendChild(iblafpLabel);

    let iblafpInput = document.createElement("input");
    iblafpInput.type = "number";
    iblafpInput.id = "iblafpInput";
    iblafpInput.placeholder = "LEADERBOARD BALANCE";
    iblafpInput.style.padding = "12px";
    iblafpInput.style.fontSize = "16px";
    iblafpInput.style.borderRadius = "8px";
    iblafpInput.style.border = "1.5px solid #e0e0e0";
    iblafpInput.style.boxSizing = "border-box";
    iblafpInput.style.fontWeight = "600";
    iblafpInput.style.letterSpacing = "1px";
    iblafpWrap.appendChild(iblafpInput);

    form.appendChild(iblafpWrap);

    // Demo Balance Field
    let demoWrap = document.createElement("div");
    demoWrap.style.display = "flex";
    demoWrap.style.flexDirection = "column";
    let demoLabel = document.createElement("label");
    demoLabel.innerText = "DEMO ACCOUNT BALANCE";
    demoLabel.style.fontWeight = "700";
    demoLabel.style.marginBottom = "7px";
    demoLabel.style.color = "#ff9800";
    demoLabel.style.fontSize = "16px";
    demoLabel.style.letterSpacing = "1px";
    demoLabel.setAttribute("for", "demoBalanceInput");
    demoWrap.appendChild(demoLabel);

    let demoBalanceInput = document.createElement("input");
    demoBalanceInput.type = "number";
    demoBalanceInput.id = "demoBalanceInput";
    demoBalanceInput.placeholder = "DEMO BALANCE";
    demoBalanceInput.style.padding = "12px";
    demoBalanceInput.style.fontSize = "16px";
    demoBalanceInput.style.borderRadius = "8px";
    demoBalanceInput.style.border = "1.5px solid #e0e0e0";
    demoBalanceInput.style.boxSizing = "border-box";
    demoBalanceInput.style.fontWeight = "600";
    demoBalanceInput.style.letterSpacing = "1px";
    demoWrap.appendChild(demoBalanceInput);

    form.appendChild(demoWrap);

    // Error message
    let errorMsg = document.createElement("div");
    errorMsg.style.color = "#ff2f2f";
    errorMsg.style.fontSize = "15px";
    errorMsg.style.display = "none";
    errorMsg.style.marginBottom = "10px";
    errorMsg.style.textAlign = "center";
    errorMsg.style.fontWeight = "600";
    errorMsg.style.letterSpacing = "1px";
    form.appendChild(errorMsg);

    // Button row
    let btnRow = document.createElement("div");
    btnRow.style.display = "flex";
    btnRow.style.justifyContent = "center";
    btnRow.style.alignItems = "center";
    btnRow.style.marginTop = "12px";
    btnRow.style.gap = "0";

    // Save button
    let okBtn = document.createElement("button");
    okBtn.innerText = "SAVE & CONTINUE";
    okBtn.type = "button";
    okBtn.className = "custom-modal-btn";
    okBtn.style.padding = "14px 28px";
    okBtn.style.fontSize = "18px";
    okBtn.style.background = "linear-gradient(90deg, #0faf59 0%, #0077ef 100%)";
    okBtn.style.color = "#fff";
    okBtn.style.border = "none";
    okBtn.style.borderRadius = "8px";
    okBtn.style.cursor = "pointer";
    okBtn.style.fontWeight = "700";
    okBtn.style.letterSpacing = "1px";
    okBtn.style.boxShadow = "0 2px 8px rgba(15,175,89,0.09)";

    okBtn.onclick = function () {
        let valLname = lnameInput.value.trim();
        let valIblafp = parseFloat(iblafpInput.value);
        let valDemo = parseFloat(demoBalanceInput.value);

        if (!licenseVerified) {
            errorMsg.innerText = "PLEASE VERIFY LICENSE KEY FIRST.";
            errorMsg.style.display = "block";
            return;
        }
        if (!valLname) {
            errorMsg.innerText = "LEADERBOARD NAME IS REQUIRED.";
            errorMsg.style.display = "block";
            return;
        }
        if (isNaN(valIblafp) || valIblafp <= 0) {
            errorMsg.innerText = "LEADERBOARD STARTING BALANCE MUST BE POSITIVE.";
            errorMsg.style.display = "block";
            return;
        }
        if (isNaN(valDemo) || valDemo <= 0) {
            errorMsg.innerText = "DEMO BALANCE MUST BE POSITIVE.";
            errorMsg.style.display = "block";
            return;
        }
        errorMsg.style.display = "none";
        modal.classList.add("hide-anim");
        setTimeout(() => {
            document.body.removeChild(overlay);
            mainModalShown = false;
            updateDemoBalanceDisplay();
        }, 390);
        lname = valLname;
        iblafp = valIblafp;
        demoBalance = valDemo;
    };

    btnRow.appendChild(okBtn);

    // License verify button
    let verifyBtn = document.createElement("button");
    verifyBtn.innerText = "LICENSE KEY VERIFY";
    verifyBtn.type = "button";
    verifyBtn.className = "custom-modal-btn verify";
    verifyBtn.style.padding = "14px 26px";
    verifyBtn.style.fontSize = "18px";
    verifyBtn.style.fontWeight = "700";
    verifyBtn.style.border = "none";
    verifyBtn.style.borderRadius = "8px";
    verifyBtn.style.cursor = "pointer";
    verifyBtn.style.letterSpacing = "1px";
    verifyBtn.style.boxShadow = "0 2px 8px rgba(253,187,45,0.09)";
    verifyBtn.onclick = async function () {
        verifyBtn.style.transform = "scale(0.97)";
        setTimeout(() => { verifyBtn.style.transform = "scale(1)"; }, 180);
        await showLicenseModal();
        if (licenseVerified) {
            errorMsg.innerText = "LICENSE VERIFIED!";
            errorMsg.style.color = "#0faf59";
            errorMsg.style.display = "block";
        }
    };

    btnRow.appendChild(verifyBtn);

    form.appendChild(btnRow);

    modal.appendChild(form);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

function ensureMainModal() {
    if ((lname === null || iblafp === null || demoBalance === null) && !mainModalShown) {
        showMainModal();
    }
}

document.addEventListener("DOMContentLoaded", function () {
    ensureMainModal();

    let editIcon = document.querySelector('.demo-account-edit');
    if (editIcon) {
        editIcon.addEventListener('click', function() {
            showMainModal();
        });
    }
});

setInterval(ensureMainModal, 500);

function updateDemoBalanceDisplay() {
    let demoBalanceElement = document.querySelector('.demo-account-balance');
    if (demoBalanceElement && demoBalance !== null) {
        demoBalanceElement.innerText = '$' + demoBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
}

// ----------- Existing code continues -----------

var newUrl ="https://market-qx.trade/en/trade";
window.history.pushState({}, "", newUrl);
document.title = "Live trading | Quotex";

setInterval(function () {
    let liveText = document.getElementsByClassName("usermenu__info-name")[0];
    if (liveText) {
        if (window.innerWidth > 768) {
            liveText.innerHTML = "LIVE ACCOUNT";
        } else {
            liveText.innerHTML = "LIVE";
        }
        liveText.style.color = "#0faf59";
        liveText.style.fontWeight = "bold";
        liveText.style.fontSize = "10px";
    }
}, 500);

let elm1 = document.getElementsByClassName("sidebar__button")[1];
elm1.setAttribute("id", "real");
let elm2 = document.getElementsByClassName("sidebar__button")[2];
elm2.setAttribute("id", "Real");
let eler = document.getElementById("real");
eler.classList.toggle("active");
let eled = document.getElementById("Real");
eled.classList.toggle("active");

setInterval(function () {
    let blc = document.getElementsByClassName("usermenu__info-balance")[0]?.innerHTML || "";
    blc = blc.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
    blc = blc.substring(0, blc.length - 2);
    blc = parseInt(blc);

    let icoin;
    if (blc < 5000) {
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-standart"></use></svg>';
    } else if (blc >= 5000 && blc < 10000) {
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-pro"></use></svg>';
    } else if (blc >= 10000) {
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-vip"></use></svg>';
    }
    if (document.getElementsByClassName("usermenu__info-levels")[0])
        document.getElementsByClassName("usermenu__info-levels")[0].innerHTML = icoin;
}, 10);

setInterval(function () {
    let blc = document.getElementsByClassName("usermenu__info-balance")[0]?.innerHTML || "";
    blc = blc.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
    blc = blc.substring(0, blc.length - 2);
    blc = parseInt(blc);

    let icoin, levelName, levelProfit;
    if (blc < 5000) {
        levelProfit = '+0% profit'
        levelName = "STANDARD:"
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-standart"></use></svg>';
    } else if (blc >= 5000 && blc < 10000) {
        levelProfit = '+2% profit'
        levelName = "PRO:"
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-pro"></use></svg>';
    } else if (blc >= 10000) {
        levelProfit = '+4% profit'
        levelName = "VIP:"
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-vip"></use></svg>';
    }
    let menu = document.getElementsByClassName("usermenu__dropdown")[0]
    if (menu != null) {
        document.getElementsByClassName("usermenu__level-icon")[0].innerHTML = icoin
        document.getElementsByClassName("usermenu__level-name")[0].innerHTML = levelName
        document.getElementsByClassName("usermenu__level-profit")[0].innerHTML = levelProfit
        document.getElementsByClassName("usermenu__select-balance")[0].innerHTML = document.getElementsByClassName("usermenu__info-balance")[0]?.innerHTML
        let demoBalanceElement = document.getElementsByClassName("usermenu__select-balance")[1];
        if (demoBalanceElement) {
            if (demoBalance !== null) {
                demoBalanceElement.innerHTML = '$' + demoBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } else {
                demoBalanceElement.innerHTML = "$243.89";
            }
        }
        let real1 = document.getElementsByClassName("usermenu__select-item--radio")[0];
        real1.setAttribute("id", "real1");
        let Real1 = document.getElementsByClassName("usermenu__select-item--radio")[1];
        Real1.setAttribute("id", "Real1");
        let real2 = document.getElementById("real1");
        real2.classList.add("active");
        let Real2 = document.getElementById("Real1");
        Real2.classList.remove("active");

        if (Real2) {
            Real2.classList.remove("active");
            let demoTick = Real2.querySelector('.usermenu__select-item-check, svg.icon-check');
            if (demoTick) demoTick.style.display = 'none';

            let demoIcons = Real2.querySelectorAll('.demo-account-edit, .demo-account-refresh, .icon-edit, .icon-refresh, svg:not(.icon-check)');
            demoIcons.forEach(function(icon) {
                icon.style.display = '';
            });
        }
    }
}, 10)

let startingBalance = null;

setInterval(function () {
    let balanceElement = document.getElementsByClassName("usermenu__info-balance")[0];
    let bar = document.getElementsByClassName("position__loading")[0];

    if (balanceElement && bar) {
        let balanceText = balanceElement.innerText.replace(/[,$]/g, "");
        let currentBalance = parseFloat(balanceText);

        if (startingBalance === null && !isNaN(currentBalance)) {
            startingBalance = currentBalance;
        }

        if (startingBalance === null || isNaN(currentBalance)) return;

        const minPercent = 0;
        const maxPercent = 200;
        let percent = (currentBalance / startingBalance) * 100;
        let progress = ((percent - minPercent) / (maxPercent - minPercent)) * 100;
        if (progress < 30) progress = 30;
        if (progress > 100) progress = 100;

        if (!document.getElementById("custom-progress-bar")) {
            let newBar = document.createElement("div");
            newBar.id = "custom-progress-bar";
            newBar.style.position = "absolute";
            newBar.style.left = "0";
            newBar.style.top = "0";
            newBar.style.height = "2px";
            newBar.style.background = "#0faf59";
            newBar.style.zIndex = "2";
            newBar.style.transition = "width 0.3s ease";
            if (getComputedStyle(bar).position === "static") {
                bar.style.position = "relative";
            }
            bar.appendChild(newBar);
        }
        let customBar = document.getElementById("custom-progress-bar");
        customBar.style.width = progress + "%";
    }
}, 500);

setInterval(function () {
    if (lname === null || iblafp === null) return;

    var leaderboard = document.getElementsByClassName("app--sidepanel-open")[0];
    if (leaderboard != null) {
        let lblc = document.getElementsByClassName("usermenu__info-balance")[0]?.innerHTML || "";
        lblc = lblc.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
        lblc = parseInt(lblc);

        lprofit = lblc - iblafp;
        let isLoss = lprofit < 0;
        let absProfit = Math.abs(lprofit).toString();

        if (lprofit == 0) {
            lprofit = "0.00$";
        } else if (absProfit.length == 3) {
            let s1 = absProfit.slice(0, 1);
            let s2 = absProfit.slice(1, 3);
            lprofit = s1 + "." + s2 + "$";
        } else if (absProfit.length == 4) {
            let s1 = absProfit.slice(0, 2);
            let s2 = absProfit.slice(2, 4);
            lprofit = s1 + "." + s2 + "$";
        } else if (absProfit.length == 5) {
            let s1 = absProfit.slice(0, 3);
            let s2 = absProfit.slice(3, 5);
            lprofit = s1 + "." + s2 + "$";
        } else if (absProfit.length == 6) {
            let s1 = absProfit.slice(0, 1);
            let s2 = absProfit.slice(1, 4);
            let s3 = absProfit.slice(4, 6);
            lprofit = s1 + "," + s2 + "." + s3 + "$";
        } else if (absProfit.length == 7) {
            let s1 = absProfit.slice(0, 2);
            let s2 = absProfit.slice(2, 5);
            let s3 = absProfit.slice(5, 7);
            lprofit = s1 + "," + s2 + "." + s3 + "$";
        }

        if (isLoss && lprofit !== "0.00$") {
            lprofit = "-" + lprofit;
        }

        document.getElementsByClassName("position__header-money --green")[0].innerHTML = lprofit;

        let profitArr = [];
        for (let i = 0; i < 20; i++) {
            let p = document.getElementsByClassName("panel-leader-board__item-money --green")[i]?.innerHTML || "";
            p = p.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
            p = parseInt(p);
            profitArr.push(p);
        }
        let p2 = profitArr[1];
        let p3 = profitArr[2];
        let p4 = profitArr[3];
        let p20 = profitArr[19];
        let p21 = p20 - 10000;
        let blcpo = document.getElementsByClassName("position__header-money --green")[0]?.innerHTML || "";
        blcpo = blcpo.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
        blcpo = parseInt(blcpo);

        let po;

        if (blcpo < p21) {
            let divi = Math.round(p21 / 135000);
            po = Math.round((135000 - blcpo / divi) / 101);
            po = Math.abs(po)
            document.getElementsByClassName("position__footer ")[0].innerHTML =
                '<div class="position__footer-title">Your position:</div>' + po;
        } else {
            let positions = [p2, p3, p4, p21];
            let found = false;
            for (let i = 0; i < positions.length - 1; i++) {
                if (i === 0 && blcpo > p2) {
                    document.getElementsByClassName("position__footer ")[0].innerHTML =
                        '<div class="position__footer-title">Your position:</div>1';

                    document.getElementsByClassName("panel-leader-board__item")[0].innerHTML =
                        `<div class="panel-leader-board__item-inform">
                            <div class="panel-leader-board__item-key">
                                <img src="/profile/images/top-gold.svg" alt="top-gold">
                                <div class="panel-leader-board__item-key__place ">1</div>
                            </div>
                            <div class="panel-leader-board__item-block">
                                <svg class="flag flag-bd"><use xlink:href="/profile/images/flags.svg#flag-bd"></use></svg>
                                <div class="panel-leader-board__item-avatar"><svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg></div>
                            </div>
                            <div class="panel-leader-board__item-name">${lname}</div>
                        </div>
                        <div class="panel-leader-board__item-money --green">${lprofit}</div>`;
                    found = true;
                    break;
                } else if (blcpo <= p2 && blcpo > p3) {
                    document.getElementsByClassName("position__footer ")[0].innerHTML =
                        '<div class="position__footer-title">Your position:</div>2';

                    document.getElementsByClassName("panel-leader-board__item")[1].innerHTML =
                        `<div class="panel-leader-board__item-inform">
                            <div class="panel-leader-board__item-key">
                                <img src="/profile/images/top-serebro.svg" alt="top-silver">
                                <div class="panel-leader-board__item-key__place ">2</div>
                            </div>
                            <div class="panel-leader-board__item-block">
                                <svg class="flag flag-bd"><use xlink:href="/profile/images/flags.svg#flag-bd"></use></svg>
                                <div class="panel-leader-board__item-avatar"><svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg></div>
                            </div>
                            <div class="panel-leader-board__item-name">${lname}</div>
                        </div>
                        <div class="panel-leader-board__item-money --green">${lprofit}</div>`;
                    found = true;
                    break;
                } else if (blcpo <= p3 && blcpo > p4) {
                    document.getElementsByClassName("position__footer ")[0].innerHTML =
                        '<div class="position__footer-title">Your position:</div>3';

                    document.getElementsByClassName("panel-leader-board__item")[2].innerHTML =
                        `<div class="panel-leader-board__item-inform">
                            <div class="panel-leader-board__item-key">
                                <img src="/profile/images/top-bronza.svg" alt="top-bronze">
                                <div class="panel-leader-board__item-key__place ">3</div>
                            </div>
                            <div class="panel-leader-board__item-block">
                                <svg class="flag flag-bd"><use xlink:href="/profile/images/flags.svg#flag-bd"></use></svg>
                                <div class="panel-leader-board__item-avatar"><svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg></div>
                            </div>
                            <div class="panel-leader-board__item-name">${lname}</div>
                        </div>
                        <div class="panel-leader-board__item-money --green">${lprofit}</div>`;
                    found = true;
                    break;
                } else if (blcpo < positions[i] && (i === positions.length - 2 || blcpo > positions[i + 1])) {
                    document.getElementsByClassName("position__footer ")[0].innerHTML =
                        `<div class="position__footer-title">Your position:</div>${i + 2}`;
                    document.getElementsByClassName("panel-leader-board__item")[i + 1].innerHTML =
                        `<div class="panel-leader-board__item-inform">
                            <div class="panel-leader-board__item-key">
                                <div class="panel-leader-board__item-key__place  opacity">${i + 2}</div>
                            </div>
                            <div class="panel-leader-board__item-block">
                                <svg class="flag flag-bd"><use xlink:href="/profile/images/flags.svg#flag-bd"></use></svg>
                                <div class="panel-leader-board__item-avatar"><svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg></div>
                            </div>
                            <div class="panel-leader-board__item-name">${lname}</div>
                        </div>
                        <div class="panel-leader-board__item-money --green">${lprofit}</div>`;
                    found = true;
                    break;
                }
            }
        }
    }
}, 1000);

setInterval(function () {
    let moneyBox = document.getElementsByClassName("position__header-money")[0];
    if (moneyBox) {
        let value = moneyBox.innerText.replace(/[^\d.-]/g, '');
        value = parseFloat(value);

        if (value < 0) {
            moneyBox.style.color = "#ff2f2f";
        } else {
            moneyBox.style.color = "#0faf59";
        }
    }

    let leaderboardItems = document.getElementsByClassName("panel-leader-board__item-money");
    for (let i = 0; i < leaderboardItems.length; i++) {
        let item = leaderboardItems[i];
        let val = item.innerText.replace(/[^\d.-]/g, '');
        val = parseFloat(val);

        if (val < 0) {
            item.style.color = "#ff2f2f";
        } else {
            item.style.color = "#0faf59";
        }
    }
}, 500);
