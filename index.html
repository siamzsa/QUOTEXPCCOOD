// ==UserScript==
// @name         QX NILOY V1.8.9 + Leaderboard FAST (No Password) + Deposit Popup No Refresh + License Verify (Smart Remember) + Unlimited Loss LB
// @version      7.8.12-nopass-licensed-unlimited-loss
// @description  Deposit button opens custom popup ONLY (no refresh/no redirect), all features intact. Cancel closes just the popup. NO PASSWORD REQUIRED. **License verification (remembers while active). Unlimited loss position calc on leaderboard.**
// @author       QX
// @match        *://market-qx.trade/*
// @grant        none
// ==/UserScript==

(function () {
'use strict';

// =========================
// License Data Helper
// =========================
const LOCAL_KEY = "qx_license_data_v1";
const DEVICE_ID_KEY = "uniqueDeviceID";
function getDeviceId() {
    let id = localStorage.getItem(DEVICE_ID_KEY);
    if (!id) {
        id = `dev_${Math.random().toString(36).substring(2,10)}_${Date.now()}`;
        localStorage.setItem(DEVICE_ID_KEY, id);
    }
    return id;
}
function getSavedLicense() {
    try { return JSON.parse(localStorage.getItem(LOCAL_KEY)) || {}; }
    catch { return {}; }
}
function setSavedLicense(obj) {
    localStorage.setItem(LOCAL_KEY, JSON.stringify(obj));
}
function clearSavedLicense() {
    localStorage.removeItem(LOCAL_KEY);
}

// =========================
// Firebase Config for License
// =========================
const firebaseConfig = {
  apiKey: "AIzaSy8m3iuH0de6K31q58DlDcm4RFsJfNTt0Y",
  authDomain: "xsiam-8cd91.firebaseapp.com",
  databaseURL: "https://xsiam-8cd91-default-rtdb.firebaseio.com",
  projectId: "xsiam-8cd91",
  storageBucket: "xsiam-8cd91.appspot.com",
  messagingSenderId: "449795686178",
  appId: "1:449795686178:web:67631b23b88be6a0eaef7b",
  measurementId: "G-C987LSZV4G"
};

// =========================
// Firebase Loader
// =========================
function loadFirebase(callback) {
    if (window.firebase && window.firebase.database) {
        callback();
        return;
    }
    const appScript = document.createElement("script");
    appScript.src = "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";
    appScript.onload = () => {
        const databaseScript = document.createElement("script");
        databaseScript.src = "https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js";
        databaseScript.onload = callback;
        document.body.appendChild(databaseScript);
    };
    document.body.appendChild(appScript);
}

// =========================
// License Verification UI
// =========================
function createUserPanel(licenseKeyDefault) {
    const container = document.createElement("div");
    container.id = "verifyCard";
    container.style.cssText = `
        position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
        background:#fff; padding:30px; border-radius:12px; text-align:center;
        width:360px; box-shadow:0 15px 40px rgba(0,0,0,0.25);
        font-family: 'Segoe UI', sans-serif; z-index:99999;
    `;

    // Cancel button
    const cancelButton = document.createElement("div");
    cancelButton.innerHTML = "&times;";
    cancelButton.style.cssText = `
        position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer;
        color:#888; transition: all 0.2s ease;
    `;
    cancelButton.onmouseover = () => { cancelButton.style.color = "#e74c3c"; };
    cancelButton.onmouseout = () => { cancelButton.style.color = "#888"; };
    cancelButton.onclick = () => { container.remove(); };
    container.appendChild(cancelButton);

    const title = document.createElement("h2");
    title.innerHTML = `QX NILOY BD<br><span style="font-size:14px;color:#555;cursor:pointer">@ni9bd</span>`;
    title.style.cssText = `color:#0d6efd;font-size:22px;margin-bottom:20px;font-weight:600;`;
    title.onclick = () => { window.open("https://t.me/ni9bd", "_blank"); };
    container.appendChild(title);

    const subtitle = document.createElement("p");
    subtitle.innerText = "License Verification";
    subtitle.style.cssText = `color:#0d6efd;margin-bottom:20px;font-size:14px;`;
    container.appendChild(subtitle);

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Enter license key";
    input.value = licenseKeyDefault || "";
    input.style.cssText = `
        width:100%; padding:12px 15px; margin-bottom:15px;
        border:1.8px solid #0d6efd; border-radius:8px; font-size:14px;
        outline:none; color:#333;
    `;
    container.appendChild(input);

    const button = document.createElement("button");
    button.innerText = "Verify License";
    button.style.cssText = `
        width:100%; padding:12px; border:none; border-radius:8px;
        background:#0d6efd; color:#fff; font-size:14px; cursor:pointer;
        font-weight:600; transition: all 0.3s ease; margin-bottom:10px;
    `;
    button.onmouseover = () => { button.style.background="#0b5ed7"; button.style.transform="scale(1.03)"; };
    button.onmouseout = () => { button.style.background="#0d6efd"; button.style.transform="scale(1)"; };
    container.appendChild(button);

    const message = document.createElement("div");
    message.id = "message";
    message.style.cssText = `margin-bottom:10px;font-weight:500;font-size:14px;`;
    container.appendChild(message);

    const activeDevicesDisplay = document.createElement("div");
    activeDevicesDisplay.id = "activeDevicesDisplay";
    activeDevicesDisplay.style.cssText = `font-weight:500;color:#ffc107;font-size:13px;`;
    container.appendChild(activeDevicesDisplay);

    const uniqueDeviceID = getDeviceId();
    const deviceId = document.createElement("div");
    deviceId.innerText = `Device ID: ${uniqueDeviceID}`;
    deviceId.style.cssText = `font-size:12px;color:#999;margin-top:15px;`;
    container.appendChild(deviceId);

    document.body.appendChild(container);
    return {input, button, message, container, activeDevicesDisplay, uniqueDeviceID};
}

// =========================
// License Verification Logic (Realtime Database)
// =========================
function verifyLicenseInFirebase(licenseKey, deviceID, callback) {
    if (!window.firebase) return callback({status: "error", message: "Firebase not loaded"});
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {}
    const db = firebase.database();
    const licensesRef = db.ref("licenses");
    licensesRef.once("value").then(snapshot => {
        let found = false, result = { status: "not_found" };
        snapshot.forEach(childSnap => {
            const lic = childSnap.val();
            const id = childSnap.key;
            if(lic.licenseKey === licenseKey) {
                found = true;
                if(lic.status === "blocked") {
                    result = {
                        status: "blocked",
                        activeDevices: lic.activeDevices || 0,
                        deviceLimit: lic.deviceLimit,
                        devices: lic.devices || [],
                        id
                    };
                } else {
                    let devices = lic.devices || [];
                    if(!devices.includes(deviceID)) devices.push(deviceID);
                    let updatedDevices = devices.length;
                    let newStatus = (updatedDevices > lic.deviceLimit) ? "blocked" : "active";
                    result = {
                        status: newStatus,
                        activeDevices: updatedDevices,
                        deviceLimit: lic.deviceLimit,
                        devices,
                        id
                    };
                    licensesRef.child(id).update({
                        activeDevices: updatedDevices,
                        status: newStatus,
                        devices: devices
                    });
                }
            }
        });
        if(!found) return callback({status: "not_found"});
        callback(result);
    }).catch(err => {
        callback({status:"error", message:"DB error"});
    });
}

// Check license in the DB (but don't increase device count)
function checkLicenseStatus(licenseKey, deviceID, callback) {
    if (!window.firebase) return callback({status: "error", message: "Firebase not loaded"});
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {}
    const db = firebase.database();
    const licensesRef = db.ref("licenses");
    licensesRef.once("value").then(snapshot => {
        let found = false, result = { status: "not_found" };
        snapshot.forEach(childSnap => {
            const lic = childSnap.val();
            if(lic.licenseKey === licenseKey) {
                found = true;
                if(lic.status === "blocked") {
                    result = {
                        status: "blocked",
                        activeDevices: lic.activeDevices || 0,
                        deviceLimit: lic.deviceLimit,
                        devices: lic.devices || []
                    };
                } else {
                    const devices = lic.devices || [];
                    if (devices.includes(deviceID)) {
                        result = {status: "active"};
                    } else if (devices.length < lic.deviceLimit) {
                        result = {status: "active"};
                    } else {
                        result = {status: "blocked"};
                    }
                }
            }
        });
        if(!found) return callback({status: "not_found"});
        callback(result);
    }).catch(err => {
        callback({status:"error", message:"DB error"});
    });
}

// =========================
// License Verification GATE
// =========================
function startLicenseGate(onReady) {
    loadFirebase(function() {
        const saved = getSavedLicense();
        const deviceID = getDeviceId();
        if (saved.licenseKey && saved.status === "active") {
            checkLicenseStatus(saved.licenseKey, deviceID, function(res) {
                if (res.status === "active") {
                    onReady();
                    setSavedLicense({
                        licenseKey: saved.licenseKey,
                        status: "active",
                        lastCheck: Date.now()
                    });
                } else {
                    clearSavedLicense();
                    showLicenseForm(onReady, "");
                }
            });
        } else {
            showLicenseForm(onReady, saved.licenseKey || "");
        }
    });
}

function showLicenseForm(onReady, licenseKeyDefault) {
    const {input, button, message, container, activeDevicesDisplay, uniqueDeviceID} = createUserPanel(licenseKeyDefault);

    button.addEventListener("click", function() {
        const licenseKey = input.value.trim();
        message.innerHTML = "";
        activeDevicesDisplay.innerHTML = "";
        if (!licenseKey) {
            message.innerHTML = "Please enter a license key.";
            message.style.color="#e74c3c";
            return;
        }
        button.disabled = true;
        verifyLicenseInFirebase(licenseKey, uniqueDeviceID, function(result) {
            button.disabled = false;
            if(result.status === "blocked") {
                message.innerHTML = "License is blocked!";
                message.style.color="#e74c3c";
                activeDevicesDisplay.innerHTML = `Active Devices: ${result.activeDevices || 0} / ${result.deviceLimit}`;
                clearSavedLicense();
            } else if(result.status === "active") {
                message.innerHTML = "License Verified!";
                message.style.color="#2ecc71";
                setSavedLicense({
                    licenseKey,
                    status: "active",
                    lastCheck: Date.now()
                });
                setTimeout(()=>{ container.remove(); onReady(); }, 900);
            } else if(result.status === "not_found") {
                message.innerHTML = "Invalid license!";
                message.style.color="#e74c3c";
                clearSavedLicense();
            } else {
                message.innerHTML = "Error verifying license.";
                message.style.color="#e74c3c";
                clearSavedLicense();
            }
        });
    });

    input.addEventListener("keydown", e => { if(e.key==="Enter"){ e.preventDefault(); button.click(); } });
}

// =========================
// Main Script (Runs only after license OK)
// =========================
function startMainScript() {
// === Main script starts here ===

if (location.href === "https://market-qx.trade/en/trade") {
    location.replace("https://market-qx.trade/en/demo-trade");
    return;
}

if (location.href === "https://market-qx.trade/en/demo-trade") {
    const fakeUrl = "https://market-qx.trade/en/trade";
    const fakeTitle = "Live trading | Quotex";
    document.title = fakeTitle;
    new MutationObserver(() => {
        if (document.title !== fakeTitle) document.title = fakeTitle;
    }).observe(document.querySelector('title'), { childList: true });
    history.replaceState(null, "", fakeUrl);
}
const now = Date.now();
const pwKey = atob("c2x0ZWNoX3ZlcmlmaWVkX2luZm8=");
const balKey = atob("aW5pdGlhbEJhbGFuY2VJbmZv");
const lbKey = atob("c2x0ZWNoX2xlYWRlcmJvYXJkX2RhdGE=");
const demoBalKey = "sltechbd_demo_balance";

const selectors = {
    positionHeaderMoney: ".position__header-money.--green, .position__header-money.--red",
    usermenuBalance: ".---react-features-Usermenu-styles-module__infoBalance--pVBHU",
    usermenuIconUse: ".---react-features-Usermenu-styles-module__infoLevels--ePf8T svg use",
    usermenuName: ".---react-features-Usermenu-styles-module__infoName--SfrTV.---react-features-Usermenu-styles-module__demo--TmWTp",
    levelName: ".---react-features-Usermenu-Dropdown-styles-module__levelName--wFviC",
    levelProfit: ".---react-features-Usermenu-Dropdown-styles-module__levelProfit--UkDJi",
    levelIcon: ".---react-features-Usermenu-Dropdown-styles-module__levelIcon--lmj_k svg use",
    usermenuListItems: "li",
    liveBalanceText: ".---react-features-Usermenu-styles-module__infoText--58LeE .---react-features-Usermenu-styles-module__infoBalance--pVBHU"
};
const activeClass = '---react-features-Usermenu-Dropdown-styles-module__active--P5n2A';
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const numFromText = s => s ? parseFloat(s.replace(/[^0-9.]/g, "")) : NaN;

function formatWithThousands(num) {
    return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatProfitDisplay(diff) {
    const val = formatWithThousands(Math.abs(diff));
    if (diff < 0) {
        return `-${val}$`;
    } else {
        return `${val}$`;
    }
}

let initialBal = 0;
const savedBal = localStorage.getItem(balKey);
if (savedBal) {
    const d = JSON.parse(savedBal);
    if (now - d.timestamp < 864e5) initialBal = parseFloat(d.balance);
}

// Demo balance logic
let demoBalance = 10000;
const savedDemoBal = localStorage.getItem(demoBalKey);
if (savedDemoBal) {
    const d = JSON.parse(savedDemoBal);
    if (now - d.timestamp < 864e5) demoBalance = parseFloat(d.balance);
}

function formatAmount(num) { return "$" + num.toFixed(2); }

function spoofUI() {
    const listItems = $$(selectors.usermenuListItems);
    if (!listItems.length) return;
    const demoLi = listItems.find(li => li.innerText.includes("Demo Account"));
    const liveLi = listItems.find(li => li.innerText.includes("Live"));
    if (!demoLi || !liveLi) return;
    const demoBalanceElem = demoLi.querySelector("b");
    const liveBalanceElem = liveLi.querySelector("b");
    if (!demoBalanceElem || !liveBalanceElem) return;

    const fixedDemoAmountStr = formatAmount(demoBalance);
    const liveBalanceFromUI = $(selectors.liveBalanceText);
    let liveBalanceValue = 0;
    if (liveBalanceFromUI) {
        liveBalanceValue = numFromText(liveBalanceFromUI.textContent);
        if (isNaN(liveBalanceValue)) liveBalanceValue = 0;
    }
    const liveAmountStr = formatAmount(liveBalanceValue);

    demoBalanceElem.textContent = fixedDemoAmountStr;
    liveBalanceElem.textContent = liveAmountStr;
    if (demoLi.classList.contains(activeClass)) demoLi.classList.remove(activeClass);
    if (!liveLi.classList.contains(activeClass)) liveLi.classList.add(activeClass);
}

let lastProfitDiff = null;
let currentExpandPercent = parseInt(localStorage.getItem('expandPercent')) || 0;

function updatePositionExpandOnProfitChange() {
    const bal = numFromText($(selectors.usermenuBalance)?.textContent);
    if (isNaN(bal)) return;
    const diff = bal - initialBal;
    if (diff !== lastProfitDiff) {
        currentExpandPercent = Math.floor(Math.random() * 91) + 10;
        lastProfitDiff = diff;
        localStorage.setItem('expandPercent', currentExpandPercent);

        const expandSpan = document.querySelector(".position__loading .position__expand");
        if (expandSpan) expandSpan.style.width = currentExpandPercent + "%";

        const slider = document.getElementById('capitalPercentSlider');
        if (slider) {
            slider.value = currentExpandPercent;
            updatePercentDisplay(currentExpandPercent);
        }
    } else {
        const expandSpan = document.querySelector(".position__loading .position__expand");
        if (expandSpan) expandSpan.style.width = currentExpandPercent + "%";

        const slider = document.getElementById('capitalPercentSlider');
        if (slider) {
            updatePercentDisplay(currentExpandPercent);
        }
    }
}

function updatePercentDisplay(value) {
    let display = document.getElementById("sliderPercentDisplay");
    if (!display) return;
    display.textContent = value + "%";
}

const leaderboardSelector = '.leader-board__items';
const leaderboardRowSelector = '.leader-board__item';
const yourHeaderSelector = '.position__header';
const yourFooterSelector = '.position__footer';

let currentRowIndex = null;
const originalRows = {};

// --- UNLIMITED LOSS POSITION FORMULA ---
// For unlimited loss, after max loss point, keep increasing position linearly (not fixed at 60000).
// Instead of fixed points array, we use a line from last point (profit: -10000, position: 60000)
// and continue: every -$1000 loss increases position by 2000 (or any large enough scale).
function calculateInterpolatedPosition(profit) {
    const points = [
        { profit: -10000, position: 60000 }, // heavy loss
        { profit: 0, position: 58471 },      // zero profit
        { profit: 1, position: 3154 },       // small profit
        { profit: 7886, position: 21 },      // screenshot sample: top position
        { profit: 20000, position: 1 }       // very high profit: best position
    ];
    const sortedPoints = points.slice().sort((a, b) => a.profit - b.profit);

    // Unlimited loss: if loss is bigger (profit more negative) than -10000, keep increasing position
    if (profit <= sortedPoints[0].profit) {
        // Slope for extension: every -$1000 after -10000 means +2000 position
        const slope = 2000 / 1000; // 2 position per $1 loss
        const extraLoss = Math.abs(profit) - 10000;
        return Math.round(60000 + Math.max(0, extraLoss) * slope);
    }
    if (profit >= sortedPoints[sortedPoints.length - 1].profit)
        return sortedPoints[sortedPoints.length - 1].position;

    for (let i = 0; i < sortedPoints.length - 1; i++) {
        const p1 = sortedPoints[i];
        const p2 = sortedPoints[i + 1];
        if (profit >= p1.profit && profit <= p2.profit) {
            const m = (p2.position - p1.position) / (p2.profit - p1.profit);
            const pos = m * (profit - p1.profit) + p1.position;
            return Math.round(pos);
        }
    }
    return sortedPoints[0].position;
}

function updateLinearPosition(profit) {
    const footer = document.querySelector(yourFooterSelector);
    if (!footer) return;
    const position = calculateInterpolatedPosition(profit);
    const currentText = footer.innerText.replace(/\D/g, '');
    const newText = position.toString();
    if (currentText !== newText) {
        footer.innerHTML = `<div class="position__footer-title">Your position:</div>${newText}`;
        localStorage.setItem('lastPositionNumber', newText);
    }
}

function applySavedPosition() {
    const saved = localStorage.getItem('lastPositionNumber');
    const footer = document.querySelector(yourFooterSelector);
    if (saved && footer) {
        footer.innerHTML = `<div class="position__footer-title">Your position:</div>${saved}`;
    }
}

function parseMoney(text) {
    return parseFloat(text.replace(/[^0-9.-]+/g, '')) || 0;
}

function getYourData() {
    const header = document.querySelector(yourHeaderSelector);
    if (!header) return null;

    const nameEl = header.querySelector('.position__header-name');
    const name = nameEl?.textContent.trim() ?? '';

    const moneyEl = header.querySelector('.position__header-money');
    const profitText = moneyEl?.textContent.trim() ?? '';
    const profit = parseMoney(profitText);

    if (!moneyEl) {
        return {
            name,
            profit: 0,
            profitText: profitText || '0.00 $',
            flagCode: 'ca'
        };
    }

    const flagSvg = nameEl.querySelector('svg');
    const flagClass = flagSvg?.getAttribute('class') || '';
    const flagUse = flagSvg?.querySelector('use')?.getAttribute('xlink:href') || '';
    const flagCode = flagClass.replace('flag-', '') || flagUse.split('#')[1];

    return { name, profit, profitText, flagCode };
}

function updateFooter(positionNum) {
    const footer = document.querySelector(yourFooterSelector);
    if (footer) {
        footer.innerHTML = `<div class="position__footer-title">Your position:</div>${positionNum}`;
    }
}

function restoreOldRow(index) {
    const row = document.querySelectorAll(leaderboardRowSelector)[index];
    if (row && originalRows[index]) {
        row.innerHTML = originalRows[index];
    }
}

function updateLeaderboard(user) {
    const leaderboard = document.querySelector(leaderboardSelector);
    if (!leaderboard) return;
    const rows = Array.from(leaderboard.querySelectorAll(leaderboardRowSelector));
    if (!rows.length) return;
    const yourIndex = rows.findIndex(row => {
        const moneyEl = row.querySelector('.leader-board__item-money');
        return moneyEl && parseMoney(moneyEl.textContent) <= user.profit;
    });
    const targetIndex = yourIndex === -1 ? rows.length - 1 : yourIndex;
    if (targetIndex !== currentRowIndex) {
        if (currentRowIndex !== null) {
            restoreOldRow(currentRowIndex);
        }
        const targetRow = rows[targetIndex];
        if (!targetRow) return;
        if (!originalRows[targetIndex]) {
            originalRows[targetIndex] = targetRow.innerHTML;
        }
        const flagSVG = targetRow.querySelector('.leader-board__item-block svg.flag');
        const flagUSE = flagSVG?.querySelector('use');
        if (flagSVG && flagUSE && user.flagCode) {
            flagSVG.setAttribute('class', `flag flag-${user.flagCode}`);
            flagUSE.setAttribute('xlink:href', `/profile/images/flags.svg#flag-${user.flagCode}`);
        }
        const avatarDiv = targetRow.querySelector('.leader-board__item-avatar');
        if (avatarDiv) {
            avatarDiv.innerHTML = `<svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg>`;
        }
        const nameDiv = targetRow.querySelector('.leader-board__item-name');
        if (nameDiv) {
            nameDiv.textContent = user.name;
        }
        const moneyDiv = targetRow.querySelector('.leader-board__item-money');
        if (moneyDiv) {
            moneyDiv.textContent = formatProfitDisplay(user.profit);
            moneyDiv.style.color = user.profit < 0 ? "#fd4d3c" : "#0faf59";
        }
        currentRowIndex = targetIndex;
        updateFooter(targetIndex + 1);
    }
}

function checkAndUpdateLeaderboard() {
    const user = getYourData();
    if (!user) {
        if (currentRowIndex !== null) {
            restoreOldRow(currentRowIndex);
            currentRowIndex = null;
        }
        updateFooter(calculateInterpolatedPosition(0));
        return;
    }
    const leaderboard = document.querySelector(leaderboardSelector);
    if (!leaderboard) return;
    const rows = Array.from(leaderboard.querySelectorAll(leaderboardRowSelector));
    if (rows.length < 20) return;
    const row20 = rows[19];
    const profit20 = parseMoney(row20.querySelector('.leader-board__item-money')?.textContent || '0');
    if (user.profit >= profit20) {
        updateLeaderboard(user);
    } else {
        if (currentRowIndex !== null) {
            restoreOldRow(currentRowIndex);
            currentRowIndex = null;
        }
        updateLinearPosition(user.profit);
    }
}

function isMobile() {
    return /Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|Mobile/i.test(navigator.userAgent);
}

function updateUI() {
    const bal = numFromText($(selectors.usermenuBalance)?.textContent);
    const profitEl = $(selectors.positionHeaderMoney);
    const levelIconUse = $(selectors.usermenuIconUse);
    const levelIconDropdown = $(selectors.levelIcon);

    if (!isNaN(bal) && profitEl) {
        const diff = bal - initialBal;
        profitEl.innerText = formatProfitDisplay(diff);
        profitEl.style.color = diff < 0 ? "#fd4d3c" : "#0faf59";
    }
    let levelType = 'standart';
    if (bal > 9999.99) levelType = 'vip';
    else if (bal > 4999.99) levelType = 'pro';
    const iconHref = `/profile/images/spritemap.svg#icon-profile-level-${levelType}`;
    if (levelIconUse) levelIconUse.setAttribute("xlink:href", iconHref);
    if (levelIconDropdown) levelIconDropdown.setAttribute("xlink:href", iconHref);

    const nameEl = $(selectors.usermenuName);
    if (nameEl) {
        if (isMobile()) {
            nameEl.textContent = "Live";
        } else {
            nameEl.textContent = "Live Account";
        }
        nameEl.style.color = "#0faf59";
    }
    const levelNameElem = $(selectors.levelName);
    const levelProfitElem = $(selectors.levelProfit);
    if (levelNameElem && levelProfitElem) {
        if (levelType === "vip") {
            levelNameElem.textContent = "vip:";
            levelProfitElem.textContent = "+4% profit";
        } else if (levelType === "pro") {
            levelNameElem.textContent = "pro:";
            levelProfitElem.textContent = "+2% profit";
        } else {
            levelNameElem.textContent = "standard:";
            levelProfitElem.textContent = "+0% profit";
        }
    }
    const lbData = localStorage.getItem(lbKey);
    if (lbData) {
        const { name, flag } = JSON.parse(lbData);
        const nameBox = document.querySelector(".position__header-name");
        if (nameBox && name && flag) {
            nameBox.innerHTML = `<svg class="flag-${flag}"><use xlink:href="/profile/images/flags.svg#flag-${flag}"></use></svg> ${name}`;
        }
    }
    updatePositionExpandOnProfitChange();
    checkAndUpdateLeaderboard();
}

let timeoutId = null;
function debouncedUpdate() {
    if (timeoutId) clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
        spoofUI();
        updateUI();
    }, 50);
}
new MutationObserver(debouncedUpdate).observe(document.body, { childList: true, subtree: true });
if (document.readyState === "complete" || document.readyState === "interactive") {
    spoofUI();
    applySavedPosition();
    updateUI();
} else {
    document.addEventListener('DOMContentLoaded', () => {
        spoofUI();
        applySavedPosition();
        updateUI();
    });
}

function showDepositPopup() {
    if ($('#capitalBalancePopup')) return;
    const popup = document.createElement("div");
    popup.id = "capitalBalancePopup";
    popup.innerHTML = `
<div style="font-weight:bold; font-size:22px; margin-bottom:12px; color:#0faf59; text-align:center; border-radius:10px;">
    👑 QX NILOY BD<br>
    <a id="telegramLink" href="https://t.me/ni9bd" target="_blank" style="font-size:14px; color:#fd4d3c; text-decoration:underline; cursor:pointer;">by @ni9bd</a>
</div>
<label style="display:block; margin-bottom:6px;">
    👤 Leaderboard Name:
</label>
<input type="text" id="leaderboardNameInput" class="sl-input" value="QX NILOY BD" placeholder="QX NILOY BD" />
<label style="display:block; margin:12px 0 6px;">
    🚩 Leaderboard Flag Code:
</label>
<input type="text" id="leaderboardFlagInput" class="sl-input" placeholder="e.g. bd" />
<label style="display:block; margin:12px 0 6px;">
    🏆 Leaderboard Amount Show:
</label>
<input type="number" id="leaderboardInput" class="sl-input" placeholder="Enter leaderboard amount" />
<label style="display:block; margin:12px 0 6px;">
    Demo Account Balance:
</label>
<input type="number" id="demoBalanceInput" class="sl-input" placeholder="Enter demo balance" value="${demoBalance}" min="0" />

<label style="display:block; margin:12px 0 6px;">
    Capital % Slider:
</label>
<div style="position: relative; width: 100%; margin-bottom: 6px;">
<input type="range" id="capitalPercentSlider" class="sl-input" min="0" max="100" step="1" value="0" style="width: 100%;" />
<div id="sliderPercentDisplay" style="
position: absolute;
top: -22px;
right: 10px;
font-weight: bold;
color: #222;
background: #eee;
padding: 2px 8px;
border-radius: 6px;
user-select: none;
pointer-events: none;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
font-size: 16px;
box-shadow:0 2px 10px #2222;
">0%</div>
</div>

<div style="text-align:center; margin-top:22px;">
<button id="setCapitalBtn" class="sl-button" style="background:#fdc500; color:#222;">Set</button>
<button id="cancelCapitalBtn" class="sl-button sl-cancel" style="background:#888;">Cancel</button>
</div>
`;
    Object.assign(popup.style, {
        position: "fixed", top: "50%", left: "50%", transform: "translate(-50%, -50%)",
        background: "#fff", color: "#222",
        padding: window.innerWidth < 600 ? "5vw" : "28px", borderRadius: "20px", boxShadow: "0 16px 44px rgba(0,0,0,0.23)",
        zIndex: "10000", width: window.innerWidth < 600 ? "98vw" : "380px", maxWidth: "99vw", fontFamily: "'Segoe UI', sans-serif"
    });
    const style = document.createElement("style");
    style.textContent = `
.sl-input {
    width: 100%; padding: 13px; margin-bottom: 10px; border: 1.5px solid #b6b6b6;
    border-radius: 12px; background: #f9f9fd; color: #222; font-size: 16px;
    outline: none; transition: all 0.3s;
    box-shadow:0 2px 10px #ececec;
}
.sl-input:focus {
    border-color: #1976d2;
    box-shadow: 0 0 7px rgba(25, 118, 210, 0.4);
}
.sl-button {
    padding: 10px 24px; margin: 0 7px; background: #0077cc; border: none;
    border-radius: 10px; color: #fff; font-weight: bold; font-size: 16px; cursor: pointer;
    transition: background 0.3s, box-shadow 0.3s;
    box-shadow:0 2px 10px #ececec;
}
.sl-button:hover { background: #005fa3; }
.sl-button.sl-cancel { background: #888; }
.sl-button.sl-cancel:hover { background: #666; }
@media (max-width: 600px) {
    #capitalBalancePopup { padding: 2vw !important; width: 98vw !important; }
    .sl-input, .sl-button { font-size: 18px !important; }
}
`;
    document.head.appendChild(style);
    document.body.appendChild(popup);

    const slider = $('#capitalPercentSlider');
    const expandSpan = document.querySelector(".position__loading .position__expand");
    slider.oninput = () => {
        if (expandSpan) expandSpan.style.width = slider.value + "%";
        updatePercentDisplay(slider.value);
    };

    $('#setCapitalBtn').onclick = () => {
        const lb = parseFloat($('#leaderboardInput').value);
        const name = $('#leaderboardNameInput').value.trim();
        const flag = $('#leaderboardFlagInput').value.trim().toLowerCase();
        const ub = numFromText($(selectors.usermenuBalance)?.textContent);

        if (!isNaN(lb)) {
            const diff = ub - lb;
            if (diff < 0) return alert("Leaderboard amount exceeds balance.");
            initialBal = diff;
        } else return alert("Enter valid amount.");

        localStorage.setItem(balKey, JSON.stringify({ balance: initialBal, timestamp: now }));

        if (name && flag) localStorage.setItem(lbKey, JSON.stringify({ name, flag }));

        const demoVal = parseFloat($('#demoBalanceInput').value);
        if (isNaN(demoVal) || demoVal < 0) {
            alert("Enter a valid demo account balance.");
            return;
        }
        demoBalance = demoVal;
        localStorage.setItem(demoBalKey, JSON.stringify({ balance: demoBalance, timestamp: Date.now() }));
        spoofUI();
        updateUI();

        popup.remove();
    };
    $('#cancelCapitalBtn').onclick = () => popup.remove();
}

function hijackDepositBtn() {
    const allBtns = document.querySelectorAll('a,button');
    allBtns.forEach(btn => {
        if (btn._qxDepositPopup) return;
        if (
            (btn.href && btn.href.includes("/deposit")) ||
            (btn.textContent && btn.textContent.trim().toLowerCase() === "deposit")
        ) {
            btn._qxDepositPopup = true;
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showDepositPopup();
                return false;
            }, true);
        }
    });
}
new MutationObserver(hijackDepositBtn).observe(document.body, { childList: true, subtree: true });
if (document.readyState === "complete" || document.readyState === "interactive") {
    hijackDepositBtn();
} else {
    document.addEventListener('DOMContentLoaded', hijackDepositBtn);
}

// === End of main script ===
}

// ========== LICENSE GATE ==========
startLicenseGate(startMainScript);

})(); // END MAIN IIFE
