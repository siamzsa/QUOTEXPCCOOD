// Initialize leaderboard name and capital
let lname = null;
let iblafp = null;

// Modal status tracking
let lnameModalShown = false;
let iblafpModalShown = false;

// Show modal to set leaderboard name (same style and behavior as balance)
function showLnameModal() {
    lnameModalShown = true;

    let overlay = document.createElement("div");
    overlay.id = "lname-overlay";
    overlay.style.position = "fixed";
    overlay.style.top = "0";
    overlay.style.left = "0";
    overlay.style.width = "100vw";
    overlay.style.height = "100vh";
    overlay.style.background = "rgba(0,0,0,0.5)";
    overlay.style.zIndex = "10001";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";

    let modal = document.createElement("div");
    modal.id = "lname-modal";
    modal.style.background = "#fff";
    modal.style.borderRadius = "8px";
    modal.style.padding = "24px";
    modal.style.boxShadow = "0 2px 16px rgba(0,0,0,0.2)";
    modal.style.display = "flex";
    modal.style.flexDirection = "column";
    modal.style.alignItems = "center";
    modal.style.minWidth = "300px";

    let title = document.createElement("h2");
    title.innerText = "Set Leaderboard Name";
    title.style.marginBottom = "12px";

    let input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Enter leaderboard name";
    input.style.padding = "8px";
    input.style.fontSize = "16px";
    input.style.marginBottom = "16px";
    input.style.width = "100%";
    input.style.boxSizing = "border-box";

    let okBtn = document.createElement("button");
    okBtn.innerText = "OK";
    okBtn.style.padding = "8px 24px";
    okBtn.style.fontSize = "16px";
    okBtn.style.background = "#0faf59";
    okBtn.style.color = "#fff";
    okBtn.style.border = "none";
    okBtn.style.borderRadius = "4px";
    okBtn.style.cursor = "pointer";
    okBtn.style.marginBottom = "8px";

    let errorMsg = document.createElement("div");
    errorMsg.style.color = "#ff2f2f";
    errorMsg.style.fontSize = "14px";
    errorMsg.style.display = "none";
    errorMsg.style.marginBottom = "8px";

    okBtn.onclick = function () {
        let val = input.value.trim();
        if (!val) {
            errorMsg.innerText = "Please enter a valid name.";
            errorMsg.style.display = "block";
            return;
        }
        lname = val;
        document.body.removeChild(overlay);
        lnameModalShown = false;
        ensureIblafp(); // open balance modal next
    };

    modal.appendChild(title);
    modal.appendChild(input);
    modal.appendChild(errorMsg);
    modal.appendChild(okBtn);

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

// Show modal to enter leaderboard balance (iblafp) -- only after name set
function showIblafpModal() {
    iblafpModalShown = true;

    let overlay = document.createElement("div");
    overlay.id = "iblafp-overlay";
    overlay.style.position = "fixed";
    overlay.style.top = "0";
    overlay.style.left = "0";
    overlay.style.width = "100vw";
    overlay.style.height = "100vh";
    overlay.style.background = "rgba(0,0,0,0.5)";
    overlay.style.zIndex = "10002";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";

    let modal = document.createElement("div");
    modal.id = "iblafp-modal";
    modal.style.background = "#fff";
    modal.style.borderRadius = "8px";
    modal.style.padding = "24px";
    modal.style.boxShadow = "0 2px 16px rgba(0,0,0,0.2)";
    modal.style.display = "flex";
    modal.style.flexDirection = "column";
    modal.style.alignItems = "center";
    modal.style.minWidth = "300px";

    let title = document.createElement("h2");
    title.innerText = "Set Leaderboard Balance";
    title.style.marginBottom = "12px";

    let input = document.createElement("input");
    input.type = "number";
    input.placeholder = "Enter leaderboard balance";
    input.style.padding = "8px";
    input.style.fontSize = "16px";
    input.style.marginBottom = "16px";
    input.style.width = "100%";
    input.style.boxSizing = "border-box";

    let okBtn = document.createElement("button");
    okBtn.innerText = "OK";
    okBtn.style.padding = "8px 24px";
    okBtn.style.fontSize = "16px";
    okBtn.style.background = "#0faf59";
    okBtn.style.color = "#fff";
    okBtn.style.border = "none";
    okBtn.style.borderRadius = "4px";
    okBtn.style.cursor = "pointer";
    okBtn.style.marginBottom = "8px";

    let errorMsg = document.createElement("div");
    errorMsg.style.color = "#ff2f2f";
    errorMsg.style.fontSize = "14px";
    errorMsg.style.display = "none";
    errorMsg.style.marginBottom = "8px";

    okBtn.onclick = function () {
        let val = parseInt(input.value, 10);
        if (isNaN(val) || val <= 0) {
            errorMsg.innerText = "Please enter a valid positive number.";
            errorMsg.style.display = "block";
            return;
        }
        iblafp = val;
        document.body.removeChild(overlay);
        iblafpModalShown = false;
    };

    modal.appendChild(title);
    modal.appendChild(input);
    modal.appendChild(errorMsg);
    modal.appendChild(okBtn);

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

// Check if lname needs to be set, show modal if not
function ensureLname() {
    if (lname === null && !lnameModalShown) showLnameModal();
}

// Check if iblafp needs to be set, show modal if not (only after name is set)
function ensureIblafp() {
    if (lname !== null && iblafp === null && !iblafpModalShown) showIblafpModal();
}

// Show modal when DOM is loaded
document.addEventListener("DOMContentLoaded", function () {
    ensureLname();
});

// Change the URL to a new one
var newUrl = "https://market-qx.pro/en/trade";
window.history.pushState({}, "", newUrl);
document.title = "Live trading | Quotex";

// Change live account to Real by text and active
setInterval(function () {
    let liveText = document.getElementsByClassName("usermenu__info-name")[0];
    if (liveText) {
        if (window.innerWidth > 768) {
            liveText.innerHTML = "LIVE ACCOUNT";
        } else {
            liveText.innerHTML = "LIVE";
        }
        liveText.style.color = "#0faf59";
        liveText.style.fontWeight = "bold";
        liveText.style.fontSize = "10px";
    }
}, 500);

let elm1 = document.getElementsByClassName("sidebar__button")[1];
elm1.setAttribute("id", "real");
let elm2 = document.getElementsByClassName("sidebar__button")[2];
elm2.setAttribute("id", "Real");
let eler = document.getElementById("real");
eler.classList.toggle("active");
let eled = document.getElementById("Real");
eled.classList.toggle("active");

// Dynamic all things
setInterval(function () {
    let blc = document.getElementsByClassName("usermenu__info-balance")[0]?.innerHTML || "";
    blc = blc.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
    blc = blc.substring(0, blc.length - 2);
    blc = parseInt(blc);

    // set profile icon
    let icoin;
    if (blc < 5000) {
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-standart"></use></svg>';
    } else if (blc >= 5000 && blc < 10000) {
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-pro"></use></svg>';
    } else if (blc >= 10000) {
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-vip"></use></svg>';
    }
    if (document.getElementsByClassName("usermenu__info-levels")[0])
        document.getElementsByClassName("usermenu__info-levels")[0].innerHTML = icoin;
}, 10);

setInterval(function () {
    let blc = document.getElementsByClassName("usermenu__info-balance")[0]?.innerHTML || "";
    blc = blc.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
    blc = blc.substring(0, blc.length - 2);
    blc = parseInt(blc);

    let icoin, levelName, levelProfit;
    if (blc < 5000) {
        levelProfit = '+0% profit'
        levelName = "STANDARD:"
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-standart"></use></svg>';
    } else if (blc >= 5000 && blc < 10000) {
        levelProfit = '+2% profit'
        levelName = "PRO:"
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-pro"></use></svg>';
    } else if (blc >= 10000) {
        levelProfit = '+4% profit'
        levelName = "VIP:"
        icoin =
            '<svg class="icon-profile-level-standart"><use xlink:href="/profile/images/spritemap.svg#icon-profile-level-vip"></use></svg>';
    }
    let menu = document.getElementsByClassName("usermenu__dropdown")[0]
    if (menu != null) {
        document.getElementsByClassName("usermenu__level-icon")[0].innerHTML = icoin
        document.getElementsByClassName("usermenu__level-name")[0].innerHTML = levelName
        document.getElementsByClassName("usermenu__level-profit")[0].innerHTML = levelProfit
        document.getElementsByClassName("usermenu__select-balance")[0].innerHTML = document.getElementsByClassName("usermenu__info-balance")[0]?.innerHTML
        document.getElementsByClassName("usermenu__select-balance")[1].innerHTML = "$243.89"
        let real1 = document.getElementsByClassName("usermenu__select-item--radio")[0];
        real1.setAttribute("id", "real1");
        let Real1 = document.getElementsByClassName("usermenu__select-item--radio")[1];
        Real1.setAttribute("id", "Real1");
        let real2 = document.getElementById("real1");
        real2.classList.add("active");
        let Real2 = document.getElementById("Real1");
        Real2.classList.remove("active");
    }
}, 10)

// Initialize starting balance once when the page loads
let startingBalance = null;

// Update progress bar every 500ms
setInterval(function () {
    let balanceElement = document.getElementsByClassName("usermenu__info-balance")[0];
    let bar = document.getElementsByClassName("position__loading")[0];

    if (balanceElement && bar) {
        let balanceText = balanceElement.innerText.replace(/[,$]/g, "");
        let currentBalance = parseFloat(balanceText);

        if (startingBalance === null && !isNaN(currentBalance)) {
            startingBalance = currentBalance;
        }

        if (startingBalance === null || isNaN(currentBalance)) return;

        const minPercent = 0;
        const maxPercent = 200;
        let percent = (currentBalance / startingBalance) * 100;
        let progress = ((percent - minPercent) / (maxPercent - minPercent)) * 100;
        if (progress < 30) progress = 30;
        if (progress > 100) progress = 100;

        if (!document.getElementById("custom-progress-bar")) {
            let newBar = document.createElement("div");
            newBar.id = "custom-progress-bar";
            newBar.style.position = "absolute";
            newBar.style.left = "0";
            newBar.style.top = "0";
            newBar.style.height = "2px";
            newBar.style.background = "#0faf59";
            newBar.style.zIndex = "2";
            newBar.style.transition = "width 0.3s ease";
            if (getComputedStyle(bar).position === "static") {
                bar.style.position = "relative";
            }
            bar.appendChild(newBar);
        }
        let customBar = document.getElementById("custom-progress-bar");
        customBar.style.width = progress + "%";
    }
}, 500);


// Leaderboard setting
setInterval(function () {
    // Ensure lname and iblafp are set
    if (lname === null || iblafp === null) return;

    var leaderboard = document.getElementsByClassName("app--sidepanel-open")[0];
    if (leaderboard != null) {
        let lblc = document.getElementsByClassName("usermenu__info-balance")[0]?.innerHTML || "";
        lblc = lblc.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
        lblc = parseInt(lblc);

        lprofit = lblc - iblafp;
        let isLoss = lprofit < 0;
        let absProfit = Math.abs(lprofit).toString();

        if (lprofit == 0) {
            lprofit = "0.00$";
        } else if (absProfit.length == 3) {
            let s1 = absProfit.slice(0, 1);
            let s2 = absProfit.slice(1, 3);
            lprofit = s1 + "." + s2 + "$";
        } else if (absProfit.length == 4) {
            let s1 = absProfit.slice(0, 2);
            let s2 = absProfit.slice(2, 4);
            lprofit = s1 + "." + s2 + "$";
        } else if (absProfit.length == 5) {
            let s1 = absProfit.slice(0, 3);
            let s2 = absProfit.slice(3, 5);
            lprofit = s1 + "." + s2 + "$";
        } else if (absProfit.length == 6) {
            let s1 = absProfit.slice(0, 1);
            let s2 = absProfit.slice(1, 4);
            let s3 = absProfit.slice(4, 6);
            lprofit = s1 + "," + s2 + "." + s3 + "$";
        } else if (absProfit.length == 7) {
            let s1 = absProfit.slice(0, 2);
            let s2 = absProfit.slice(2, 5);
            let s3 = absProfit.slice(5, 7);
            lprofit = s1 + "," + s2 + "." + s3 + "$";
        }

        if (isLoss && lprofit !== "0.00$") {
            lprofit = "-" + lprofit;
        }

        document.getElementsByClassName("position__header-money --green")[0].innerHTML = lprofit;

        // All top 20 profit value
        let profitArr = [];
        for (let i = 0; i < 20; i++) {
            let p = document.getElementsByClassName("panel-leader-board__item-money --green")[i]?.innerHTML || "";
            p = p.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
            p = parseInt(p);
            profitArr.push(p);
        }
        let p20 = profitArr[19];
        let p2 = profitArr[1];
        let p3 = profitArr[2];
        let p4 = profitArr[3];
        let p5 = profitArr[4];
        let p6 = profitArr[5];
        let p7 = profitArr[6];
        let p8 = profitArr[7];
        let p9 = profitArr[8];
        let p10 = profitArr[9];
        let p11 = profitArr[10];
        let p12 = profitArr[11];
        let p13 = profitArr[12];
        let p14 = profitArr[13];
        let p15 = profitArr[14];
        let p16 = profitArr[15];
        let p17 = profitArr[16];
        let p18 = profitArr[17];
        let p19 = profitArr[18];

        let p21 = p20 - 10000;

        let blcpo = document.getElementsByClassName("position__header-money --green")[0]?.innerHTML || "";
        blcpo = blcpo.replaceAll(",", "").replaceAll("$", "").replaceAll(".", "");
        blcpo = parseInt(blcpo);

        let po;

        // Set position in leaderboard session and also in top 20 list
        if (blcpo < p21) {
            let divi = Math.round(p21 / 135000);
            po = Math.round((135000 - blcpo / divi) / 101);
            po = Math.abs(po)
            document.getElementsByClassName("position__footer ")[0].innerHTML =
                '<div class="position__footer-title">Your position:</div>' + po;
        } else {
            let names = [
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item",
                "panel-leader-board__item"
            ];
            let positions = [p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, p13, p14, p15, p16, p17, p18, p19, p20, p21];
            let found = false;
            for (let i = 0; i < positions.length; i++) {
                if (i === 0 && blcpo > p2) {
                    document.getElementsByClassName("position__footer ")[0].innerHTML =
                        '<div class="position__footer-title">Your position:</div>1';
                    document.getElementsByClassName("panel-leader-board__item")[0].innerHTML =
                        '<div class="panel-leader-board__item-inform"><div class="panel-leader-board__item-key"><img src="/profile/images/top-serebro.svg" alt="top-gold"><div class="panel-leader-board__item-key__place ">2</div></div><div class="panel-leader-board__item-block"><svg class="flag flag-bd"><use xlink:href="/profile/images/flags.svg#flag-bd"></use></svg><div class="panel-leader-board__item-avatar"><svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg></div></div><div class="panel-leader-board__item-name">' +
                        lname +
                        '</div></div><div class="panel-leader-board__item-money --green">' +
                        lprofit +
                        "</div>";
                    found = true;
                    break;
                } else if (blcpo < positions[i] && (i === 19 || blcpo > positions[i + 1])) {
                    document.getElementsByClassName("position__footer ")[0].innerHTML =
                        `<div class="position__footer-title">Your position:</div>${i + 2}`;
                    document.getElementsByClassName("panel-leader-board__item")[i + 1].innerHTML =
                        `<div class="panel-leader-board__item-inform"><div class="panel-leader-board__item-key"><div class="panel-leader-board__item-key__place  opacity">${i + 2}</div></div><div class="panel-leader-board__item-block"><svg class="flag flag-bd"><use xlink:href="/profile/images/flags.svg#flag-bd"></use></svg><div class="panel-leader-board__item-avatar"><svg class="icon-avatar-default"><use xlink:href="/profile/images/spritemap.svg#icon-avatar-default"></use></svg></div></div><div class="panel-leader-board__item-name">${lname}</div></div><div class="panel-leader-board__item-money --green">${lprofit}</div>`;
                    found = true;
                    break;
                }
            }
        }
    }
}, 1000);


(async function runLicenseCheck() {
  const waitForDOM = () => new Promise(res => {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", res);
    } else {
      res();
    }
  });

  const loadScript = src => new Promise(res => {
    if (document.querySelector(`script[src="${src}"]`)) return res();
    const s = document.createElement('script');
    s.src = src;
    s.onload = res;
    document.head.appendChild(s);
  });

  await waitForDOM();
  await loadScript('https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js');
  await loadScript('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js');

  if (!window.firebase?.apps?.length) {
    firebase.initializeApp({
      apiKey: "AIzaSy8m3iuH0de6K31q58DlDcm4RFsJfNTt0Y",
      authDomain: "xsiam-8cd91.firebaseapp.com",
      databaseURL: "https://xsiam-8cd91-default-rtdb.firebaseio.com",
      projectId: "xsiam-8cd91",
      storageBucket: "xsiam-8cd91.appspot.com",
      messagingSenderId: "449795686178",
      appId: "1:449795686178:web:67631b23b88be6a0eaef7b",
      measurementId: "G-C987LSZV4G"
    });
  }

  const db = firebase.firestore();

  if (document.getElementById("licenseModalBackdrop")) return;

  const html = `
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
      #licenseModalBackdrop {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        font-family: 'Share Tech Mono', monospace;
        color: #00ff00;
        user-select: none;
      }
      #licenseModal {
        background: #111;
        border: 2px solid #00ff00;
        padding: 30px 36px;
        border-radius: 12px;
        box-shadow: 0 0 20px #00ff00aa;
        width: 360px;
        text-align: center;
        position: relative;
      }
      #licenseModal h1 {
        font-size: 28px;
        margin: 0;
        letter-spacing: 2px;
        text-shadow: 0 0 8px #00ff00;
      }
      #licenseModal h2 {
        font-size: 16px;
        margin-top: 4px;
        color: #0f0;
        font-weight: normal;
        text-transform: uppercase;
        text-shadow: 0 0 6px #0f0;
      }
      #licenseModal > div.message-info {
        font-size: 14px;
        margin: 16px 0 6px;
        color: #0f0;
        letter-spacing: 0.8px;
      }
      #licenseModal > div.message-sub {
        font-size: 12px;
        color: #080;
        margin-bottom: 18px;
        opacity: 0.7;
      }
      #licenseKey {
        width: 100%;
        padding: 14px 12px;
        border-radius: 6px;
        border: 1px solid #00ff00;
        background: #111;
        color: #0f0;
        font-family: 'Share Tech Mono', monospace;
        font-size: 16px;
        outline: none;
        box-shadow: inset 0 0 8px #00ff00;
        transition: border-color 0.3s;
        caret-color: #0f0;
        user-select: text;
      }
      #licenseKey::placeholder {
        color: #055005;
        font-style: italic;
      }
      #licenseKey:focus {
        border-color: #0f0;
        box-shadow: 0 0 10px #0f0;
      }
      #licenseModal button {
        width: 48%;
        padding: 12px;
        font-size: 14px;
        font-family: 'Share Tech Mono', monospace;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        letter-spacing: 1px;
        user-select: none;
        transition: background 0.3s ease;
        box-shadow: 0 0 10px #00ff00aa;
      }
      #verifyBtn {
        background: linear-gradient(90deg, #00ff00, #00cc00);
        color: #000;
        font-weight: 700;
        text-shadow: 0 0 3px #000;
      }
      #verifyBtn:disabled {
        background: #006600;
        cursor: wait;
        box-shadow: none;
        color: #004400;
      }
      #cancelBtn {
        background: #222;
        color: #007700;
        opacity: 0.5;
        cursor: not-allowed;
        user-select: none;
      }
      #message {
        margin-top: 18px;
        font-size: 15px;
        min-height: 24px;
        letter-spacing: 0.5px;
        font-weight: 700;
        text-shadow:
          0 0 6px #00ff00,
          0 0 10px #00ff00;
      }
      #footer {
        margin-top: 24px;
        font-size: 12px;
        color: #008800;
        opacity: 0.7;
        user-select: none;
      }
      #footer a {
        color: #00ff00;
        text-decoration: none;
        font-weight: bold;
      }
      #footer a:hover {
        text-decoration: underline;
      }
      #footer img {
        filter: drop-shadow(0 0 3px #00ff00);
        width: 18px;
        vertical-align: middle;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #0f0;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        vertical-align: middle;
        margin-right: 8px;
      }

      @keyframes typing {
        from { width: 0; }
        to { width: 100%; }
      }
      #message.typing {
        overflow: hidden;
        white-space: nowrap;
        border-right: 3px solid #0f0;
        animation: typing 1.5s steps(30, end);
      }
    </style>

    <div id="licenseModalBackdrop" aria-modal="true" role="dialog" aria-labelledby="licenseTitle">
      <div id="licenseModal" role="document">
        <h1 id="licenseTitle">SYSTEM ACCESS</h1>
        <h2>By Rifat</h2>
        <div class="message-info">ENTER YOUR LICENSE KEY TO CONTINUE</div>
        <div class="message-sub">Authorize your device for system access</div>
        <input type="text" id="licenseKey" placeholder="Enter license key..." autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="none" />
        <div style="display:flex; justify-content:space-between; gap:8px; margin-top:12px;">
          <button id="verifyBtn">VERIFY LICENSE</button>
          <button id="cancelBtn" disabled>CANCEL</button>
        </div>
        <div id="message" aria-live="polite" role="alert"></div>
        <div id="footer">
          <div style="display:flex; justify-content:center; align-items:center; gap:6px; margin-top:18px;">
            <img src="https://cdn-icons-png.flaticon.com/512/2111/2111646.png" alt="Telegram icon" />
            <a href="https://t.me/rifat07_X" target="_blank" rel="noopener noreferrer">@rifat07_X</a>
          </div>
          <div style="margin-top:6px;">By Rifat</div>
        </div>
      </div>
    </div>
  `;

  const wrapper = document.createElement("div");
  wrapper.innerHTML = html;
  document.body.appendChild(wrapper);

  const inputEl = document.getElementById("licenseKey");
  const verifyBtn = document.getElementById("verifyBtn");
  const messageEl = document.getElementById("message");
  const modalBackdrop = document.getElementById("licenseModalBackdrop");

  const getDeviceId = () => {
    let id = localStorage.getItem("deviceId");
    if (!id) {
      id = "device-" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("deviceId", id);
    }
    return id;
  };

  verifyBtn.addEventListener("click", async () => {
    const val = inputEl.value.trim();
    messageEl.textContent = "";
    messageEl.classList.remove("typing");
    if (!val) {
      messageEl.textContent = "❗ PLEASE ENTER YOUR LICENSE KEY";
      messageEl.style.color = "#ff0000";
      return;
    }

    messageEl.innerHTML = `<span class="spinner"></span>VERIFYING...`;
    messageEl.style.color = "#00ff00";
    verifyBtn.disabled = true;

    try {
      const snap = await db.collection("licenses").where("key", "==", val).limit(1).get();
      if (snap.empty) {
        messageEl.textContent = "❌ LICENSE KEY NOT FOUND!";
        messageEl.style.color = "#ff0000";
      } else {
        const doc = snap.docs[0];
        const data = doc.data();
        const docRef = doc.ref;

        if (!data.active) {
          messageEl.textContent = "❌ LICENSE IS INACTIVE!";
          messageEl.style.color = "#ff0000";
          verifyBtn.disabled = false;
          return;
        }

        const maxDevices = data.maxDevices || 1;
        const deviceId = getDeviceId();

        const usedDevicesSnap = await db.collection("devices").where("licenseKey", "==", val).get();
        const usedDeviceCount = usedDevicesSnap.size;

        const alreadyRegistered = usedDevicesSnap.docs.some(d => d.data().deviceId === deviceId);

        if (!alreadyRegistered && usedDeviceCount >= maxDevices) {
          await docRef.update({ active: false });
          messageEl.textContent = "🚫 LICENSE EXCEEDED DEVICE LIMIT AND HAS BEEN BLOCKED!";
          messageEl.style.color = "#ff0000";
        } else {
          if (!alreadyRegistered) {
            await db.collection("devices").add({
              deviceId,
              licenseKey: val,
              verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }

          messageEl.textContent = "✅ LICENSE VERIFIED SUCCESSFULLY!";
          messageEl.style.color = "#00ff00";
          messageEl.classList.add("typing");

          setTimeout(() => {
            modalBackdrop.remove();
            document.dispatchEvent(new CustomEvent("license-verified"));
          }, 1000);
        }
      }
    } catch (e) {
      console.error(e);
      messageEl.textContent = "⚠️ ERROR VERIFYING LICENSE, TRY AGAIN LATER.";
      messageEl.style.color = "#ff0000";
    } finally {
      verifyBtn.disabled = false;
    }
  });

  inputEl.focus();
})();









// Color for profit/loss
setInterval(function () {
    let moneyBox = document.getElementsByClassName("position__header-money")[0];
    if (moneyBox) {
        let value = moneyBox.innerText.replace(/[^\d.-]/g, '');
        value = parseFloat(value);

        if (value < 0) {
            moneyBox.style.color = "#ff2f2f"; // লাল
        } else {
            moneyBox.style.color = "#0faf59"; // সবুজ
        }
    }

    let leaderboardItems = document.getElementsByClassName("panel-leader-board__item-money");
    for (let i = 0; i < leaderboardItems.length; i++) {
        let item = leaderboardItems[i];
        let val = item.innerText.replace(/[^\d.-]/g, '');
        val = parseFloat(val);

        if (val < 0) {
            item.style.color = "#ff2f2f"; // লাল
        } else {
            item.style.color = "#0faf59"; // সবুজ
        }
    }
}, 500);

// Always check for modals if not set, every 500ms (for dynamic environments)
setInterval(function () {
    ensureLname();
    ensureIblafp();
}, 500);
